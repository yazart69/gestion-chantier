<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Planning - Gantt v4.2 (Final)</title>
    <style>
        :root {
            --primary-color: #0066cc; --secondary-color: #17a2b8; --success-color: #1a7431;
            --warning-color: #f39c12; --danger-color: #c92a2a; --light-bg: #f8f9fa;
            --purple-color: #862e9c; --blue-color: #1c7ed6;
            --border-color: #dee2e6; --text-color: #495057; --shadow-light: 0 4px 15px rgba(0,0,0,0.1);
            --weekend-bg: #f1f3f5;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--light-bg); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 95%; margin: 2rem auto; padding: 2rem; background: white; border-radius: 15px; box-shadow: var(--shadow-light); }
        h1 { text-align: center; color: var(--primary-color); margin-bottom: 2rem; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 15px; width: 90%; max-width: 500px; animation: modalSlideIn 0.3s ease; }
        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .btn { background: var(--secondary-color); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-success { background: var(--success-color); } .btn-danger { background: var(--danger-color); }
        .gantt-professional { border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow-light); margin-top: 2rem; overflow-x: auto; background: #fff; }
        .gantt-controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; align-items: center; }
        .gantt-header-row { display: grid; grid-template-columns: 250px 1fr; background: var(--primary-color); color: white; font-weight: 600; height: 40px; }
        .gantt-task-header { display: flex; align-items: center; padding: 0 1rem; border-right: 1px solid rgba(255,255,255,0.3); }
        .gantt-dates-header { display: flex; }
        .gantt-date-cell { flex-shrink: 0; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--border-color); font-size: 0.7rem; text-align: center; }
        .gantt-date-cell.weekend { background-color: var(--weekend-bg); }
        .gantt-body { position: relative; }
        .gantt-row { display: grid; grid-template-columns: 250px 1fr; min-height: 50px; border-bottom: 1px solid var(--border-color); }
        .gantt-task-cell { display: flex; flex-direction: column; justify-content: center; padding: 0.5rem 1rem; background: var(--light-bg); border-right: 1px solid var(--border-color); position: relative; z-index: 5; cursor: pointer; }
        .gantt-task-name { font-weight: 600; font-size: 0.9rem; }
        .gantt-task-responsable { font-size: 0.8rem; color: #666; }
        .gantt-chart-cell { position: relative; background-image: linear-gradient(to right, var(--border-color) 1px, transparent 1px); }
        .gantt-bar { position: absolute; height: 24px; top: 50%; transform: translateY(-50%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; color: white; padding: 0 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); cursor: pointer; overflow: hidden; white-space: nowrap; }
        .gantt-bar-planifie { background: var(--blue-color); } .gantt-bar-en-cours { background: var(--success-color); }
        .gantt-bar-en-retard { background: var(--danger-color); } .gantt-bar-termine { background: #14532d; }
        .gantt-bar-travaux-sup { background: var(--purple-color); }
        .gantt-progress { position: absolute; left: 0; top: 0; height: 100%; background: rgba(255,255,255,0.3); border-radius: 12px; }
        .gantt-summary { margin-top: 2rem; padding: 1.5rem; background: var(--light-bg); border-radius: 12px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; text-align: center; }
        .summary-item h3 { font-size: 1rem; color: var(--text-color); margin-bottom: 0.5rem; }
        .summary-item .value { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
        .summary-budget { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .summary-budget.on-track .value { color: var(--success-color); }
        .summary-budget.over-budget .value { color: var(--danger-color); }
    </style>
</head>
<body>
    <div id="modalTache" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span><h3 id="modalTitreAction"></h3>
            <div class="form-group"><label>Nom de la t√¢che *</label><input type="text" id="modalTacheNom"></div>
            <div class="two-column">
                <div class="form-group"><label>Heures-Homme Pr√©vues *</label><input type="number" id="modalTacheHeures" min="1" value="8"></div>
                <div class="form-group"><label>Nombre d'Op√©rateurs *</label><input type="number" id="modalTacheOperateurs" min="1" value="1"></div>
            </div>
            <div class="form-group"><label>Responsable *</label><select id="modalTacheResponsable"></select></div>
            <div class="form-group"><label>Date de d√©but *</label><input type="date" id="modalTacheDateDebut"></div>
            <div class="two-column">
                <div class="form-group"><label>Progression (%)</label><input type="range" id="modalTacheProgression" min="0" max="100" value="0" oninput="this.nextElementSibling.textContent = this.value + '%'"><span>0%</span></div>
                <div class="form-group"><label>Statut</label><select id="modalTacheStatut"></select></div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn btn-danger" id="btnSupprimerTache">Supprimer</button>
                <button class="btn" id="cancelModalTache">Annuler</button>
                <button class="btn btn-success" id="btnSauvegarderTache">Valider</button>
            </div>
        </div>
    </div>
    <div id="modalProgression" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close">&times;</span><h3>üìä Modifier la Progression</h3>
            <div class="form-group"><label id="modalProgressionTacheNom"></label></div>
            <div class="form-group"><label>Progression</label><input type="range" id="modalProgressionSlider" min="0" max="100" oninput="this.nextElementSibling.textContent = this.value + '%'"><span>0%</span></div>
            <div class="form-group"><label>Statut</label><select id="modalProgressionStatut"></select></div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn" id="cancelModalProgression">Annuler</button>
                <button class="btn btn-success" id="btnSauvegarderProgression">Valider</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Planning de Chantier</h1>
        <div class="gantt-controls">
            <button class="btn" id="addTaskBtn">‚ûï Ajouter une T√¢che</button>
            <div style="margin-left: auto; display: flex; gap: 0.5rem;"><button class="btn" id="viewDayBtn">Jour</button><button class="btn" id="viewWeekBtn">Semaine</button><button class="btn" id="viewMonthBtn">Mois</button></div>
        </div>
        <div id="ganttContainer"></div>
        <div class="gantt-summary" id="ganttSummary">
            <div class="summary-grid">
                <div class="summary-item"><h3>Heures Pr√©vues</h3><div class="value" id="heures-prevues">0 h</div></div>
                <div class="summary-item"><h3>Heures Pass√©es</h3><div class="value" id="heures-passees">0 h</div></div>
                <div class="summary-item"><h3>Heures Restantes</h3><div class="value" id="heures-restantes">0 h</div></div>
            </div>
            <div class="summary-grid summary-budget">
                <div class="summary-item"><h3>Budget Heures Initial</h3><div class="value" id="budget-initial">0 h</div></div>
                <div class="summary-item"><h3>Heures Planifi√©es</h3><div class="value" id="budget-planifie">0 h</div></div>
                <div class="summary-item" id="budget-indicator"><h3>Statut Budget</h3><div class="value"></div></div>
            </div>
        </div>
    </div>

    <script>
        class GanttChart {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.tasks = [];
                this.viewMode = 'week';
                this.responsables = ['Conducteur de travaux', 'Responsable d\'agence', 'Charg√© d\'affaires', 'HSE', 'Equipe operateurs', 'Chef atelier St Maurice'];
                this.statuts = {'planifie': 'Planifi√©', 'en-cours': 'En cours', 'en-retard': 'En retard', 'termine': 'Termin√©', 'travaux-sup': 'Travaux sup'};
                this.hoursPerDay = 8.5;
                this.estimatedHoursBudget = 250;
                this.initModals();
                this.initControls();
            }

            calculateEndDate(start, workingDays) {
                let d = new Date(start);
                let addedDays = 0;
                if (workingDays < 1) return d;
                let initialDay = d.getDay();
                if (initialDay !== 0 && initialDay !== 6) {
                    addedDays = 1;
                }
                while (addedDays < workingDays) {
                    d.setDate(d.getDate() + 1);
                    if (d.getDay() !== 0 && d.getDay() !== 6) { addedDays++; }
                }
                return d;
            }

            loadTasks(tasks) { this.tasks = tasks.map(t => ({...t, dateDebut: new Date(t.dateDebut)})); this.render(); }
            saveTask(taskData) {
                const index = this.tasks.findIndex(t => t.id === taskData.id);
                if (index !== -1) { this.tasks[index] = taskData; } else { this.tasks.push(taskData); }
                this.render();
            }
            deleteTask(id) {
                if (confirm('Supprimer cette t√¢che ?')) { this.tasks = this.tasks.filter(t => t.id !== id); this.render(); }
            }

            populateStatusSelect(selectElement, selectedValue) {
                selectElement.innerHTML = '';
                for (const [key, value] of Object.entries(this.statuts)) {
                    selectElement.innerHTML += `<option value="${key}" ${key === selectedValue ? 'selected' : ''}>${value}</option>`;
                }
            }

            initModals() {
                this.modalTache = document.getElementById('modalTache');
                this.modalProgression = document.getElementById('modalProgression');
                this.modalTache.querySelector('.close').onclick = () => this.closeTaskModal();
                document.getElementById('cancelModalTache').onclick = () => this.closeTaskModal();
                document.getElementById('btnSauvegarderTache').onclick = () => this.handleSaveTask();
                document.getElementById('btnSupprimerTache').onclick = () => this.handleDeleteTask();
                this.modalProgression.querySelector('.close').onclick = () => this.closeProgressModal();
                document.getElementById('cancelModalProgression').onclick = () => this.closeProgressModal();
                document.getElementById('btnSauvegarderProgression').onclick = () => this.handleSaveProgress();
            }
            
            openTaskModal(taskId = null) {
                this.currentEditingTaskId = taskId;
                const isEditing = taskId !== null;
                const task = isEditing ? this.tasks.find(t=>t.id===taskId) : {};
                
                document.getElementById('modalTitreAction').textContent = isEditing ? '‚úèÔ∏è Modifier la T√¢che' : '‚ûï Ajouter une T√¢che';
                document.getElementById('btnSupprimerTache').style.display = isEditing ? 'inline-flex' : 'none';
                
                const selectResponsable = document.getElementById('modalTacheResponsable');
                selectResponsable.innerHTML = this.responsables.map(r => `<option value="${r}" ${task.responsable === r ? 'selected' : ''}>${r}</option>`).join('');
                
                this.populateStatusSelect(document.getElementById('modalTacheStatut'), task.statut || 'planifie');

                document.getElementById('modalTacheNom').value = task.nom || '';
                document.getElementById('modalTacheDateDebut').value = (task.dateDebut || new Date()).toISOString().split('T')[0];
                document.getElementById('modalTacheHeures').value = task.heuresHomme || 8;
                document.getElementById('modalTacheOperateurs').value = task.operateurs || 1;
                document.getElementById('modalTacheProgression').value = task.progression || 0;
                document.getElementById('modalTacheProgression').nextElementSibling.textContent = `${task.progression || 0}%`;
                
                this.modalTache.style.display = 'flex';
            }

            handleSaveTask() {
                const nom = document.getElementById('modalTacheNom').value.trim();
                if (!nom) { alert('Le nom est obligatoire.'); return; }
                const heuresHomme = parseFloat(document.getElementById('modalTacheHeures').value) || 0;
                const operateurs = parseInt(document.getElementById('modalTacheOperateurs').value) || 1;

                const taskData = {
                    id: this.currentEditingTaskId || Date.now(), nom,
                    responsable: document.getElementById('modalTacheResponsable').value,
                    dateDebut: new Date(document.getElementById('modalTacheDateDebut').value),
                    heuresHomme: heuresHomme,
                    operateurs: operateurs,
                    duree: Math.ceil(heuresHomme / (operateurs * this.hoursPerDay)),
                    progression: parseInt(document.getElementById('modalTacheProgression').value),
                    statut: document.getElementById('modalTacheStatut').value
                };
                this.saveTask(taskData);
                this.closeTaskModal();
            }
            handleDeleteTask() { if (this.currentEditingTaskId) { this.deleteTask(this.currentEditingTaskId); this.closeTaskModal(); } }
            closeTaskModal() { this.modalTache.style.display = 'none'; }
            
            openProgressModal(taskId) {
                const task = this.tasks.find(t=>t.id===taskId);
                if (!task) return;
                this.currentProgressTaskId = taskId;
                document.getElementById('modalProgressionTacheNom').textContent = `T√¢che : ${task.nom}`;
                const slider = document.getElementById('modalProgressionSlider');
                slider.value = task.progression;
                slider.nextElementSibling.textContent = `${task.progression}%`;
                this.populateStatusSelect(document.getElementById('modalProgressionStatut'), task.statut);
                this.modalProgression.style.display = 'flex';
            }
            handleSaveProgress() {
                const task = this.tasks.find(t=>t.id===this.currentProgressTaskId);
                if (!task) return;
                task.progression = parseInt(document.getElementById('modalProgressionSlider').value);
                task.statut = document.getElementById('modalProgressionStatut').value;
                this.saveTask(task);
                this.closeProgressModal();
            }
            closeProgressModal() { this.modalProgression.style.display = 'none'; }
            
            initControls() {
                document.getElementById('addTaskBtn').onclick = () => this.openTaskModal();
                document.getElementById('viewDayBtn').onclick = () => { this.viewMode = 'day'; this.render(); };
                document.getElementById('viewWeekBtn').onclick = () => { this.viewMode = 'week'; this.render(); };
                document.getElementById('viewMonthBtn').onclick = () => { this.viewMode = 'month'; this.render(); };
            }

            render() {
                this.container.innerHTML = '';
                if (this.tasks.length === 0) {
                    this.container.innerHTML = `<div style="text-align: center; color: #666; padding: 40px; background: var(--light-bg); border-radius: 8px;"><p>Le planning est vide.</p></div>`;
                    this.updateDashboard(); return;
                }
                this.tasks.sort((a, b) => a.dateDebut - b.dateDebut);
                const minDate = new Date(this.tasks[0].dateDebut);
                let maxDate = new Date(minDate);
                this.tasks.forEach(task => {
                    const endDate = this.calculateEndDate(task.dateDebut, task.duree);
                    if (endDate > maxDate) maxDate = endDate;
                });
                const headerCells = this.generateDateHeader(minDate, maxDate);
                const ganttProfessional = document.createElement('div');
                ganttProfessional.className = 'gantt-professional';
                const ganttContainer = document.createElement('div');
                ganttContainer.className = 'gantt-container';
                const headerRow = document.createElement('div');
                headerRow.className = 'gantt-header-row';
                headerRow.innerHTML = `<div class="gantt-task-header">T√¢ches</div><div class="gantt-dates-header">${headerCells.html}</div>`;
                const ganttBody = document.createElement('div');
                ganttBody.className = 'gantt-body';
                this.tasks.forEach(task => ganttBody.appendChild(this.generateTaskRow(task, minDate, headerCells.colWidth)));
                ganttContainer.appendChild(headerRow);
                ganttContainer.appendChild(ganttBody);
                ganttProfessional.appendChild(ganttContainer);
                this.container.appendChild(ganttProfessional);
                this.updateDashboard();
            }
            
            updateDashboard() {
                const totalHeuresPlanifiees = this.tasks.filter(t => t.statut !== 'travaux-sup').reduce((sum, task) => sum + task.heuresHomme, 0);
                const heuresTravauxSup = this.tasks.filter(t => t.statut === 'travaux-sup').reduce((sum, task) => sum + task.heuresHomme, 0);
                const budgetTotalAjuste = this.estimatedHoursBudget + heuresTravauxSup;
                const heuresPassees = this.tasks.reduce((sum, task) => sum + (task.heuresHomme * (task.progression / 100)), 0);
                document.getElementById('heures-prevues').textContent = `${(totalHeuresPlanifiees + heuresTravauxSup).toFixed(1)} h`;
                document.getElementById('heures-passees').textContent = `${heuresPassees.toFixed(1)} h`;
                document.getElementById('heures-restantes').textContent = `${(budgetTotalAjuste - heuresPassees).toFixed(1)} h`;
                const budgetIndicator = document.getElementById('budget-indicator');
                document.getElementById('budget-initial').textContent = `${this.estimatedHoursBudget.toFixed(1)} h (+${heuresTravauxSup.toFixed(1)} h TS)`;
                document.getElementById('budget-planifie').textContent = `${totalHeuresPlanifiees.toFixed(1)} h`;
                const progressionGlobale = budgetTotalAjuste > 0 ? (heuresPassees / budgetTotalAjuste) * 100 : 0;
                const projectionFinDeChantier = progressionGlobale > 1 ? heuresPassees / (progressionGlobale / 100) : totalHeuresPlanifiees + heuresTravauxSup;
                let kpiHtml;
                let kpiClass = 'orange';
                const diff = projectionFinDeChantier - budgetTotalAjuste;
                if (diff > (budgetTotalAjuste * 0.05)) { kpiClass = 'retard'; kpiHtml = `RETARD (+${diff.toFixed(1)} h)`;
                } else if (diff < -(budgetTotalAjuste * 0.05)) { kpiClass = 'avance'; kpiHtml = `AVANCE (${diff.toFixed(1)} h)`;
                } else { kpiHtml = `DANS LES TEMPS`; }
                budgetIndicator.innerHTML = `<h3>Performance</h3><div class="value ${kpiClass}">${kpiHtml}</div><small>Projection: ${projectionFinDeChantier.toFixed(1)} h</small>`;
            }

            generateDateHeader(minDate, maxDate) {
                let html = '', colWidth = 40;
                let currentDate = new Date(minDate); currentDate.setDate(currentDate.getDate() - 2);
                let endDate = new Date(maxDate); endDate.setDate(endDate.getDate() + 7);
                if (this.viewMode === 'day') {
                    colWidth = 50;
                    while (currentDate <= endDate) { const day = currentDate.getDay(); html += `<div class="gantt-date-cell ${day === 0 || day === 6 ? 'weekend' : ''}" style="width:${colWidth}px;">${currentDate.toLocaleDateString('fr-FR', {day: '2-digit'})}</div>`; currentDate.setDate(currentDate.getDate() + 1); }
                } else if (this.viewMode === 'week') {
                    colWidth = 80;
                    while (currentDate <= endDate) { html += `<div class="gantt-date-cell" style="width:${colWidth}px;">Sem. ${this.getWeekNumber(currentDate)}</div>`; currentDate.setDate(currentDate.getDate() + 7); }
                } else { 
                    colWidth = 120; currentDate.setDate(1);
                    while (currentDate <= endDate) { html += `<div class="gantt-date-cell" style="width:${colWidth}px;">${currentDate.toLocaleDateString('fr-FR', {month: 'long', year: '2-digit'})}</div>`; currentDate.setMonth(currentDate.getMonth() + 1); }
                }
                return { html, colWidth };
            }

            generateTaskRow(task, minDate, colWidth) {
                const row = document.createElement('div');
                row.className = 'gantt-row';
                const endDate = this.calculateEndDate(task.dateDebut, task.duree);
                const calendarDuration = (endDate - task.dateDebut) / 86400000;
                let daysFromStart = (task.dateDebut - minDate) / 86400000 + 2;
                let barWidth, barLeft;
                if (this.viewMode === 'day') { barLeft = daysFromStart * colWidth; barWidth = calendarDuration * colWidth; } 
                else if (this.viewMode === 'week') { barLeft = (daysFromStart / 7) * colWidth; barWidth = (calendarDuration / 7) * colWidth; } 
                else { barLeft = (daysFromStart / 30.4) * colWidth; barWidth = (calendarDuration / 30.4) * colWidth; }
                
                row.innerHTML = `
                    <div class="gantt-task-cell"><div class="gantt-task-name">${task.nom}</div><div class="gantt-task-responsable">${task.responsable}</div></div>
                    <div class="gantt-chart-cell">
                        <div class="gantt-bar gantt-bar-${task.statut}" style="left: ${barLeft}px; width: ${barWidth}px;">
                            ${task.progression}%
                            <div class="gantt-progress" style="width: ${task.progression}%;"></div>
                        </div>
                    </div>`;
                row.querySelector('.gantt-task-cell').addEventListener('click', () => this.openTaskModal(task.id));
                row.querySelector('.gantt-bar').addEventListener('click', (e) => { e.stopPropagation(); this.openProgressModal(task.id); });
                return row;
            }

            getWeekNumber(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            }
        }
        
        const gantt = new GanttChart('ganttContainer');
        gantt.loadTasks([
            { id: 1, nom: 'D√©marrage & Pr√©paration', responsable: 'Conducteur de travaux', dateDebut: '2025-08-21', heuresHomme: 42.5, operateurs: 1, duree: 5, progression: 100, statut: 'termine' },
            { id: 2, nom: 'Sablage Zone A', responsable: 'Equipe operateurs', dateDebut: '2025-08-28', heuresHomme: 119, operateurs: 2, duree: 7, progression: 50, statut: 'en-cours' },
            { id: 3, nom: 'Peinture Zone A', responsable: 'Chef atelier St Maurice', dateDebut: '2025-09-08', heuresHomme: 85, operateurs: 1, duree: 10, progression: 0, statut: 'planifie' },
            { id: 4, nom: 'Travaux Sup. Elec', responsable: 'HSE', dateDebut: '2025-09-10', heuresHomme: 25.5, operateurs: 1, duree: 3, progression: 0, statut: 'travaux-sup' },
            { id: 5, nom: 'Validation Client', responsable: 'Charg√© d\'affaires', dateDebut: '2025-09-22', heuresHomme: 8.5, operateurs: 1, duree: 1, progression: 0, statut: 'en-retard' },
        ]);
    </script>
</body>
</html>