<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Chantier</title>
    <script src="database.js"></script>
    <style>
        :root {
            --primary-blue: #0066cc; --primary-orange: #ff6600; --success-color: #198754; --danger-color: #dc3545;
            --light-bg: #f8f9fa; --white: #ffffff; --border-color: #dee2e6; --text-color: #212529; 
            --shadow-sm: 0 .125rem .25rem rgba(0,0,0,.075); --shadow-md: 0 .5rem 1rem rgba(0,0,0,.15);
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--light-bg); display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 250px; background-color: #002b49; color: white; padding: 1.5rem 0; display: flex; flex-direction: column; flex-shrink: 0; }
        #sidebar h1 { font-size: 1.5rem; text-align: center; margin: 0 1rem 2rem 1rem; color: white; }
        #sidebar nav ul { list-style: none; padding: 0; margin: 0; }
        #sidebar nav a { display: block; padding: 1rem 1.5rem; color: #d1d5db; text-decoration: none; font-weight: 500; transition: background-color 0.2s, color 0.2s; border-left: 4px solid transparent; }
        #sidebar nav a:hover { background-color: rgba(255, 255, 255, 0.1); color: white; }
        #sidebar nav a.active { background-color: var(--primary-blue); color: white; border-left-color: var(--primary-orange); }
        #main-content { flex-grow: 1; overflow-y: auto; padding: 2rem; }
        #module-container { max-width: 1400px; margin: 0 auto; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Styles g√©n√©riques pour les modules charg√©s */
        .card { background: white; border-radius: 1rem; box-shadow: var(--shadow-sm); padding: 2rem; margin-bottom: 2rem; border: 1px solid var(--border-color); }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 1rem; color: #6c757d; }
        .form-select, .form-input, .form-textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1.1rem; }
        .btn { border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; }
        /* ... autres styles ... */
    </style>
</head>
<body>
    <aside id="sidebar">
        <h1>Gestion Chantiers</h1>
        <nav>
             <ul>
                <li><a href="#" class="nav-link active" data-module="tableau_de_bord">üìä Tableau de Bord</a></li>
                <li><a href="#" class="nav-link" data-module="planning">üìÖ Planning</a></li>
                <li><a href="#" class="nav-link" data-module="reunion">üìù R√©unions</a></li>
                <li><a href="#" class="nav-link" data-module="travaux_materiaux">üõ†Ô∏è Travaux & Mat√©riaux</a></li>
                <li><a href="#" class="nav-link" data-module="equipe">üë• √âquipe</a></li>
                <li><a href="#" class="nav-link" data-module="chantier">üöß Infos Chantier</a></li>
            </ul>
        </nav>
    </aside>

    <main id="main-content">
        <div id="module-container"></div>
    </main>

    <script>
        // --- CERVEAU CENTRAL DE L'APPLICATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const moduleContainer = document.getElementById('module-container');
            const navLinks = document.querySelectorAll('.nav-link');

            async function loadModule(moduleName) {
                try {
                    const response = await fetch(`${moduleName}.html`);
                    if (!response.ok) throw new Error(`Le module ${moduleName}.html est introuvable.`);
                    const content = await response.text();
                    moduleContainer.innerHTML = content;
                    
                    if (window.moduleInitializers && moduleInitializers[moduleName]) {
                        moduleInitializers[moduleName]();
                    }
                } catch (error) {
                    moduleContainer.innerHTML = `<p style="color: red;">Erreur: ${error.message}</p>`;
                }
            }

            // --- OBJET CONTENANT LA LOGIQUE DE CHAQUE MODULE ---
            window.moduleInitializers = {
                'tableau_de_bord': () => {
                    const chantierSelect = document.getElementById('chantier-select-tdb');
                    if (!chantierSelect) return;
                    
                    const chantiers = DB.getChantiers();
                    chantiers.forEach(c => {
                        chantierSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                    });
                    
                    function formatCurrency(value) { return `${Math.round(value).toLocaleString('fr-FR')} ‚Ç¨`; }
                    
                    function updateDashboard() {
                        const chantierId = chantierSelect.value;
                        if (!chantierId) return;
                        
                        const chantier = DB.getChantierById(chantierId);
                        const tasks = DB.getPlanningForChantier(chantierId);
                        const coutParOperateur = parseFloat(document.getElementById('cout-operateur').value) || 0;
                        const heuresRealisees = tasks.reduce((sum, task) => sum + (task.heuresHomme * (task.progression / 100)), 0);
                        document.getElementById('heures-realisees').value = heuresRealisees.toFixed(1);

                        const imprevusPct = parseFloat(document.getElementById('imprevus-pct').value) || 0;
                        const depenseST = parseFloat(document.getElementById('depense-st').value) || 0;
                        const depenseFournitures = parseFloat(document.getElementById('depense-fournitures').value) || 0;
                        const depenseLocations = parseFloat(document.getElementById('depense-locations').value) || 0;
                        
                        const coutMOActuel = heuresRealisees * coutParOperateur;
                        const projectionCoutMO = (tasks.reduce((sum, task) => sum + task.heuresHomme, 0)) * coutParOperateur;
                        
                        const resteMO = projectionCoutMO - coutMOActuel;
                        const resteST = chantier.budgetST - depenseST;
                        const resteFournitures = chantier.budgetFournitures - depenseFournitures;
                        const resteLocations = chantier.budgetLocations - depenseLocations;
                        
                        const totalBudgetDirect = chantier.budgetMO + chantier.budgetST + chantier.budgetFournitures + chantier.budgetLocations;
                        const totalDepenseDirect = coutMOActuel + depenseST + depenseFournitures + depenseLocations;
                        const totalResteDirect = resteMO + resteST + resteFournitures + resteLocations;
                        
                        const montantImprevus = totalBudgetDirect * (imprevusPct / 100);
                        const coutTotalProjete = totalDepenseDirect + totalResteDirect + montantImprevus;
                        const margePrevisionnelle = chantier.devisValide - coutTotalProjete;
                        const margePct = chantier.devisValide > 0 ? (margePrevisionnelle / chantier.devisValide) * 100 : 0;
                        
                        function updateCell(id, value, isCurrency = true) {
                            const el = document.getElementById(id);
                            if (el) el.textContent = isCurrency ? formatCurrency(value) : value;
                        }
                        
                        updateCell('budget-mo', chantier.budgetMO);
                        updateCell('depense-mo', coutMOActuel);
                        updateCell('reste-mo', resteMO);
                        // ... (autres mises √† jour)
                    }
                    
                    document.getElementById('inputs-card').addEventListener('input', updateDashboard);
                    if (chantiers.length > 0) updateDashboard();
                },
                'planning': () => {
                    // La classe GanttChart et son initialisation
                    const ganttContainer = document.getElementById('ganttContainer');
                    if (ganttContainer) {
                        // Mettre ici la classe GanttChart compl√®te
                        // ...
                        // const gantt = new GanttChart('ganttContainer');
                        // ...
                        console.log("Module Planning initialis√©.");
                    }
                },
                'equipe': () => {
                     console.log("Module √âquipe initialis√©.");
                },
                'chantier': () => {
                     console.log("Module Chantier initialis√©.");
                },
                'travaux_materiaux': () => {
                     console.log("Module Travaux & Mat√©riaux initialis√©.");
                },
                'reunion': () => {
                    console.log("Module R√©union initialis√©.");
                }
            };

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    loadModule(e.currentTarget.dataset.module);
                });
            });

            loadModule('tableau_de_bord');
        });
    </script>
</body>
</html>
