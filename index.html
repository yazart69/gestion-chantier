<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestion Chantier ‚Äì V7.2</title>
  <style>
    :root{
      --primary:#C41230; /* rouge Altrad */
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#1a1a1a;
      --muted:#6b7280;
      --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626; --info:#2563eb;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    nav button{border:1px solid #e5e7eb;background:#fff;color:#111;padding:10px 14px;border-radius:10px;cursor:pointer}
    nav button.active, .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    main{max-width:1200px;margin:18px auto;padding:0 16px 40px}
    .grid{display:grid;gap:16px}
    .g2{grid-template-columns:1.2fr 1fr}
    .g3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width: 900px){.g2,.g3{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .card h2,.card h3{margin:0 0 8px}
    .muted{color:var(--muted);font-size:.9rem}
    label{display:block;margin:8px 0 4px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    textarea{min-height:100px}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:.85rem}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{border-bottom:1px solid #eee;padding:10px;text-align:left}
    .table th{background:#fafafa}
    .table .num{text-align:right}
    .pill{padding:4px 10px;border-radius:999px;color:#fff;font-size:.8rem}
    .pill.ok{background:var(--ok)}.pill.warn{background:var(--warn)}.pill.danger{background:var(--danger)}.pill.info{background:var(--info)}
    .sr-only{position:absolute;left:-9999px}
    .right{float:right}

    /* Print */
    @media print{
      header, nav, .no-print{display:none !important}
      main{margin:0;max-width:none}
      .card{box-shadow:none;border:0;padding:0}
      .printable{page-break-inside:avoid}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="align-items:center;gap:12px">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:36px;height:36px;border-radius:9px;background:var(--primary)"></div>
          <strong>FormulAIRE ‚Äì Gestion Chantier V7.2</strong>
        </div>
        <span class="badge">Local ‚Ä¢ 100% Offline</span>
      </div>
      <nav class="wrap" style="padding-left:0">
        <button data-nav="home" class="active">Accueil</button>
        <button data-nav="reunion">R√©union</button>
        <button data-nav="chantiers">Chantiers</button>
        <button data-nav="docs">Documents</button>
        <button data-nav="parametres">Param√®tres</button>
        <button class="right no-print" onclick="printCurrent()">üñ®Ô∏è Imprimer</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- ACCUEIL -->
    <section id="page-home" class="grid g2">
      <div class="card printable" id="home-last-meeting">
        <h2>Derni√®re r√©union</h2>
        <div id="lastMeetingBlock" class="muted">Aucun compte rendu pour le moment.</div>
        <div class="actions no-print">
          <button class="btn-primary" onclick="go('reunion')">Cr√©er une r√©union</button>
          <button onclick="openLastMeetingForPrint()">Imprimer le dernier CR</button>
        </div>
      </div>

      <div class="card printable">
        <h2>Infos √©quipe & logistique</h2>
        <div class="grid g3">
          <div>
            <h3>Cong√©s</h3>
            <ul id="listConges" class="muted"></ul>
            <div class="row no-print">
              <input id="inConges" placeholder="Nom Pr√©nom" />
              <button onclick="addHomeItem('conges')">Ajouter</button>
            </div>
          </div>
          <div>
            <h3>Maladies</h3>
            <ul id="listMaladies" class="muted"></ul>
            <div class="row no-print">
              <input id="inMaladies" placeholder="Nom Pr√©nom" />
              <button onclick="addHomeItem('maladies')">Ajouter</button>
            </div>
          </div>
          <div>
            <h3>Stocks √† pr√©voir</h3>
            <ul id="listStocks" class="muted"></ul>
            <div class="row no-print">
              <input id="inStocks" placeholder="D√©signation" />
              <button onclick="addHomeItem('stocks')">Ajouter</button>
            </div>
          </div>
        </div>
        <div class="grid g3" style="margin-top:12px">
          <div>
            <h3>Commandes √† passer</h3>
            <ul id="listCommandes" class="muted"></ul>
            <div class="row no-print">
              <input id="inCommandes" placeholder="D√©signation / fournisseur" />
              <button onclick="addHomeItem('commandes')">Ajouter</button>
            </div>
          </div>
          <div>
            <h3>Raccourcis</h3>
            <div class="actions no-print">
              <button onclick="go('docs')">Centre de documents</button>
              <button onclick="go('chantiers')">Fiches chantiers</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- REUNION -->
    <section id="page-reunion" class="grid g2" style="display:none">
      <div class="card printable">
        <h2>Nouvelle r√©union</h2>
        <div class="row">
          <div>
            <label>Titre</label>
            <input id="meetTitle" placeholder="Ex: R√©union hebdo exploitation" />
          </div>
          <div>
            <label>Date</label>
            <input id="meetDate" type="date" />
          </div>
        </div>
        <label>Participants (s√©par√©s par des virgules)</label>
        <input id="meetPeople" placeholder="Ex: Sylvain Garreau, A. Martin, ..." />
        <label>Ordre du jour</label>
        <textarea id="meetAgenda" placeholder="Points √† traiter..."></textarea>
        <label>D√©cisions</label>
        <textarea id="meetDecisions" placeholder="D√©cisions act√©es..."></textarea>
        <label>Actions / TODO</label>
        <textarea id="meetTodos" placeholder="Qui fait quoi, pour quand..."></textarea>
        <div class="actions no-print">
          <button class="btn-primary" onclick="saveMeeting()">Enregistrer</button>
          <button onclick="printMeetingPreview()">Imprimer le CR</button>
          <button onclick="exportMeeting()">Exporter (HTML)</button>
        </div>
      </div>
      <div class="card printable">
        <h2>Historique</h2>
        <table class="table" id="meetingsTable">
          <thead><tr><th>Date</th><th>Titre</th><th>Participants</th><th class="no-print">Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- CHANTIERS -->
    <section id="page-chantiers" style="display:none">
      <div class="card printable">
        <h2>Fiche chantier</h2>
        <div class="grid g3">
          <div>
            <label>Nom du chantier</label>
            <input id="chName" placeholder="Ex: R√©novation ERP B√¢t. A" />
          </div>
          <div>
            <label>Client</label>
            <input id="chClient" placeholder="Ex: Ville de Lyon" />
          </div>
          <div>
            <label>Adresse</label>
            <input id="chAddress" placeholder="Adresse du chantier" />
          </div>
        </div>
        <div class="grid g3">
          <div>
            <label>Contact principal</label>
            <input id="chContact" value="Sylvain Garreau" />
          </div>
          <div>
            <label>Chef de chantier (optionnel)</label>
            <input id="chChef" placeholder="Non obligatoire" />
          </div>
          <div>
            <label>T√©l√©phone contact</label>
            <input id="chPhone" placeholder="Ex: 06 00 00 00 00" />
          </div>
        </div>

        <h3 style="margin-top:16px">Types de travaux & surfaces (m¬≤)</h3>
        <table class="table" id="tblWorks">
          <thead>
            <tr><th>Type</th><th>Description</th><th>Surface (m¬≤)</th><th class="no-print">‚Äî</th></tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><th colspan="2">Total</th><th class="num" id="worksTotal">0</th><th class="no-print"></th></tr>
          </tfoot>
        </table>
        <div class="actions no-print">
          <button onclick="addWorkRow()">+ Ajouter un type</button>
          <button class="btn-primary" onclick="saveChantier()">Enregistrer la fiche</button>
          <button onclick="printChantier()">Imprimer la fiche</button>
        </div>
      </div>

      <div class="card printable" style="margin-top:16px">
        <h2>Chantiers enregistr√©s</h2>
        <table class="table" id="chantiersTable">
          <thead><tr><th>Nom</th><th>Client</th><th>Contact</th><th>Total m¬≤</th><th class="no-print">Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- DOCUMENTS -->
    <section id="page-docs" style="display:none">
      <div class="card printable">
        <h2>Centre de documents</h2>
        <p class="muted">Base d√©di√©e aux documents import√©s et aux g√©n√©rations (impressions / exports).</p>
        <div class="no-print">
          <label class="no-print">Importer des documents (PDF, DOCX, XLSX‚Ä¶)</label>
          <input id="docImport" type="file" multiple />
          <div class="actions no-print">
            <button onclick="importDocs()">Importer</button>
          </div>
        </div>

        <h3 style="margin-top:16px">Documents import√©s</h3>
        <table class="table" id="docsTable">
          <thead><tr><th>Nom</th><th>Type</th><th>Taille</th><th>Date</th><th class="no-print">Actions</th></tr></thead>
          <tbody></tbody>
        </table>

        <h3 style="margin-top:16px">Journal des impressions / exports</h3>
        <table class="table" id="docLogsTable">
          <thead><tr><th>Date</th><th>Type</th><th>Titre</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PARAMETRES -->
    <section id="page-parametres" style="display:none">
      <div class="card printable">
        <h2>Param√®tres</h2>
        <p class="muted">La base de donn√©es <strong>personnelles</strong> a √©t√© supprim√©e. Elle est remplac√©e par une <strong>base de documents</strong> (import√©s / g√©n√©r√©s).</p>
        <div class="actions no-print">
          <button onclick="go('docs')">Ouvrir le centre de documents</button>
          <button onclick="purgeAll()" style="border-color:var(--danger);color:var(--danger)">Purger toutes les donn√©es</button>
          <button onclick="go('home')">‚Üê Retour</button>
        </div>
        <div class="muted">Version V7.2 ‚Ä¢ Stockage: IndexedDB + localStorage</div>
      </div>
    </section>
  </main>

  <template id="meetingTemplate">
    <div>
      <h2 style="margin:0 0 6px">{{titre}}</h2>
      <div class="muted">Date: {{date}} ‚Ä¢ Participants: {{people}}</div>
      <h3>Ordre du jour</h3>
      <div>{{agenda}}</div>
      <h3>D√©cisions</h3>
      <div>{{decisions}}</div>
      <h3>Actions</h3>
      <div>{{todos}}</div>
    </div>
  </template>

  <script>
    // --- Routing ---
    const pages = {
      home: document.getElementById('page-home'),
      reunion: document.getElementById('page-reunion'),
      chantiers: document.getElementById('page-chantiers'),
      docs: document.getElementById('page-docs'),
      parametres: document.getElementById('page-parametres'),
    };
    const navButtons = [...document.querySelectorAll('nav button[data-nav]')];
    function go(page){
      Object.values(pages).forEach(s=>s.style.display='none');
      pages[page].style.display='';
      navButtons.forEach(b=>b.classList.toggle('active', b.dataset.nav===page));
      localStorage.setItem('route', page);
      if(page==='docs'){ refreshDocs(); refreshDocLogs(); }
      if(page==='reunion'){ refreshMeetings(); }
      if(page==='chantiers'){ refreshChantiers(); if(!tblWorks.tbodyInitiated){addWorkRow(); addWorkRow(); tblWorks.tbodyInitiated=true;} }
      if(page==='home'){ renderLastMeeting(); renderHomeInfo(); }
    }

    // Restore route
    const lastRoute = localStorage.getItem('route')||'home';
    navButtons.forEach(b=>b.addEventListener('click',()=>go(b.dataset.nav)));

    // --- Home info state ---
    const homeInfoKey = 'homeInfoV72';
    function getHomeInfo(){ return JSON.parse(localStorage.getItem(homeInfoKey)||'{}'); }
    function setHomeInfo(v){ localStorage.setItem(homeInfoKey, JSON.stringify(v)); renderHomeInfo(); }
    function addHomeItem(kind){
      const map = {conges:'inConges', maladies:'inMaladies', stocks:'inStocks', commandes:'inCommandes'};
      const input = document.getElementById(map[kind]);
      const val = (input.value||'').trim(); if(!val) return;
      const data = getHomeInfo(); data[kind] = data[kind]||[]; data[kind].push(val); setHomeInfo(data); input.value='';
    }
    function renderHomeInfo(){
      const d = getHomeInfo();
      const renderList = (id, arr)=>{
        const ul = document.getElementById(id); ul.innerHTML='';
        (arr||[]).forEach((v,i)=>{
          const li = document.createElement('li'); li.textContent=v; li.className='row';
          const del = document.createElement('button'); del.textContent='Suppr'; del.className='no-print'; del.onclick=()=>{arr.splice(i,1); const x=getHomeInfo(); x[id.replace('list','').toLowerCase()] = arr; setHomeInfo(x);};
          li.appendChild(del); ul.appendChild(li);
        });
      };
      renderList('listConges', d.conges||[]);
      renderList('listMaladies', d.maladies||[]);
      renderList('listStocks', d.stocks||[]);
      renderList('listCommandes', d.commandes||[]);
    }

    // --- Meetings ---
    const meetKey = 'meetingsV72';
    function getMeetings(){ return JSON.parse(localStorage.getItem(meetKey)||'[]'); }
    function setMeetings(v){ localStorage.setItem(meetKey, JSON.stringify(v)); refreshMeetings(); renderLastMeeting(); }
    function saveMeeting(){
      const m = {
        id: crypto.randomUUID(),
        titre: document.getElementById('meetTitle').value.trim()||'R√©union',
        date: document.getElementById('meetDate').value||new Date().toISOString().slice(0,10),
        people: document.getElementById('meetPeople').value.trim(),
        agenda: sanitize(document.getElementById('meetAgenda').value),
        decisions: sanitize(document.getElementById('meetDecisions').value),
        todos: sanitize(document.getElementById('meetTodos').value),
        createdAt: Date.now()
      };
      const arr = getMeetings();
      arr.push(m); setMeetings(arr);
      // Reset form
      ['meetTitle','meetDate','meetPeople','meetAgenda','meetDecisions','meetTodos'].forEach(id=>document.getElementById(id).value='');
    }
    function refreshMeetings(){
      const tbody = document.querySelector('#meetingsTable tbody'); tbody.innerHTML='';
      const arr = getMeetings().sort((a,b)=>b.date.localeCompare(a.date));
      arr.forEach(m=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${m.date}</td><td>${escapeHtml(m.titre)}</td><td>${escapeHtml(m.people||'')}</td><td class="no-print"></td>`;
        const td = tr.querySelector('td.no-print');
        const btn1 = mkBtn('Voir',()=>previewMeeting(m));
        const btn2 = mkBtn('Impr.',()=>printHtml(renderMeetingHtml(m), `CR ‚Äì ${m.date} ${m.titre}`));
        const btn3 = mkBtn('Exporter',()=>exportAsHtml(renderMeetingHtml(m), `CR_${m.date}_${slug(m.titre)}.html`));
        const btn4 = mkBtn('Suppr',()=>{ if(confirm('Supprimer ce CR ?')){ const a=getMeetings().filter(x=>x.id!==m.id); setMeetings(a);} });
        [btn1,btn2,btn3,btn4].forEach(b=>td.appendChild(b));
        tbody.appendChild(tr);
      });
    }
    function renderLastMeeting(){
      const last = getMeetings().sort((a,b)=>b.createdAt-a.createdAt)[0];
      const el = document.getElementById('lastMeetingBlock');
      if(!last){ el.textContent = 'Aucun compte rendu pour le moment.'; return; }
      el.innerHTML = renderMeetingHtml(last);
    }
    function openLastMeetingForPrint(){
      const last = getMeetings().sort((a,b)=>b.createdAt-a.createdAt)[0];
      if(!last){ alert('Aucun CR trouv√©'); return; }
      printHtml(renderMeetingHtml(last), `CR ‚Äì ${last.date} ${last.titre}`);
    }
    function renderMeetingHtml(m){
      const tpl = document.getElementById('meetingTemplate').innerHTML;
      return tpl
        .replace('{{titre}}', escapeHtml(m.titre))
        .replace('{{date}}', escapeHtml(m.date))
        .replace('{{people}}', escapeHtml(m.people||''))
        .replace('{{agenda}}', nl2br(escapeHtml(m.agenda||'')))
        .replace('{{decisions}}', nl2br(escapeHtml(m.decisions||'')))
        .replace('{{todos}}', nl2br(escapeHtml(m.todos||'')));
    }
    function previewMeeting(m){
      const w = window.open('', '_blank');
      w.document.write(`<html><head><title>CR ${escapeHtml(m.titre)}</title><meta charset='utf-8'><style>body{font-family:system-ui;line-height:1.45;padding:24px} h2{margin:0 0 6px} .muted{color:#6b7280}</style></head><body>${renderMeetingHtml(m)}</body></html>`);
      w.document.close();
    }
    function printMeetingPreview(){
      const m = {
        titre: document.getElementById('meetTitle').value.trim()||'R√©union',
        date: document.getElementById('meetDate').value||new Date().toISOString().slice(0,10),
        people: document.getElementById('meetPeople').value.trim(),
        agenda: document.getElementById('meetAgenda').value,
        decisions: document.getElementById('meetDecisions').value,
        todos: document.getElementById('meetTodos').value,
      };
      printHtml(renderMeetingHtml(m), `CR ‚Äì ${m.date} ${m.titre}`);
    }

    // --- Chantiers ---
    const chKey = 'chantiersV72';
    function getChantiers(){ return JSON.parse(localStorage.getItem(chKey)||'[]'); }
    function setChantiers(v){ localStorage.setItem(chKey, JSON.stringify(v)); refreshChantiers(); }

    const tblWorks = document.getElementById('tblWorks');
    function addWorkRow(row){
      const tbody = tblWorks.querySelector('tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input placeholder="Ex: Peinture" value="${row?.type||''}"></td>
        <td><input placeholder="D√©tail (optionnel)" value="${row?.desc||''}"></td>
        <td><input type="number" step="0.01" min="0" value="${row?.m2||''}" oninput="recalcWorksTotal()" class="num"></td>
        <td class="no-print"></td>`;
      const del = mkBtn('Suppr', ()=>{ tr.remove(); recalcWorksTotal(); });
      tr.querySelector('td.no-print').appendChild(del);
      tbody.appendChild(tr);
      recalcWorksTotal();
    }
    function recalcWorksTotal(){
      const m2 = [...tblWorks.querySelectorAll('tbody tr')].reduce((sum,tr)=>{
        const v = parseFloat(tr.children[2].querySelector('input').value||'0');
        return sum + (isFinite(v)?v:0);
      },0);
      document.getElementById('worksTotal').textContent = m2.toFixed(2);
    }
    function collectWorks(){
      return [...tblWorks.querySelectorAll('tbody tr')].map(tr=>({
        type: tr.children[0].querySelector('input').value.trim(),
        desc: tr.children[1].querySelector('input').value.trim(),
        m2: parseFloat(tr.children[2].querySelector('input').value||'0')||0,
      })).filter(r=>r.type||r.m2>0);
    }
    function saveChantier(){
      const c = {
        id: crypto.randomUUID(),
        name: document.getElementById('chName').value.trim()||'Chantier',
        client: document.getElementById('chClient').value.trim(),
        address: document.getElementById('chAddress').value.trim(),
        contact: document.getElementById('chContact').value.trim()||'Sylvain Garreau',
        chef: document.getElementById('chChef').value.trim(), // optionnel
        phone: document.getElementById('chPhone').value.trim(),
        works: collectWorks(),
        totalM2: parseFloat(document.getElementById('worksTotal').textContent)||0,
        createdAt: Date.now(),
      };
      const arr = getChantiers(); arr.push(c); setChantiers(arr);
      // reset form minimal
      ['chName','chClient','chAddress','chChef','chPhone'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('chContact').value='Sylvain Garreau';
      tblWorks.querySelector('tbody').innerHTML=''; addWorkRow(); recalcWorksTotal();
      alert('Chantier enregistr√©.');
    }
    function refreshChantiers(){
      const tbody = document.querySelector('#chantiersTable tbody'); tbody.innerHTML='';
      getChantiers().sort((a,b)=>b.createdAt-a.createdAt).forEach(c=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(c.name)}</td><td>${escapeHtml(c.client||'')}</td><td>${escapeHtml(c.contact||'')}</td><td class='num'>${(c.totalM2||0).toFixed(2)}</td><td class='no-print'></td>`;
        const td=tr.querySelector('td.no-print');
        td.appendChild(mkBtn('Voir',()=>previewChantier(c)));
        td.appendChild(mkBtn('Impr.',()=>printHtml(renderChantierHtml(c), `Fiche chantier ‚Äì ${c.name}`)));
        td.appendChild(mkBtn('Suppr',()=>{ if(confirm('Supprimer cette fiche ?')){ setChantiers(getChantiers().filter(x=>x.id!==c.id)); } }));
        tbody.appendChild(tr);
      });
    }
    function renderChantierHtml(c){
      const rows = c.works.map(w=>`<tr><td>${escapeHtml(w.type)}</td><td>${escapeHtml(w.desc||'')}</td><td class='num'>${w.m2.toFixed(2)}</td></tr>`).join('');
      return `
        <div>
          <h2 style="margin:0 0 8px">${escapeHtml(c.name)}</h2>
          <div class="muted">Client: ${escapeHtml(c.client||'-')} ‚Ä¢ Contact principal: ${escapeHtml(c.contact||'Sylvain Garreau')} ‚Ä¢ Chef de chantier: ${escapeHtml(c.chef||'‚Äî')} ‚Ä¢ T√©l: ${escapeHtml(c.phone||'-')}</div>
          <div class="muted">Adresse: ${escapeHtml(c.address||'-')}</div>
          <h3 style="margin-top:12px">Types de travaux (m¬≤)</h3>
          <table style="width:100%;border-collapse:collapse" border="1" cellspacing="0" cellpadding="6">
            <thead><tr><th>Type</th><th>Description</th><th style="text-align:right">Surface (m¬≤)</th></tr></thead>
            <tbody>${rows||'<tr><td colspan=3>Aucun type saisi</td></tr>'}</tbody>
            <tfoot><tr><th colspan="2" style="text-align:right">Total</th><th style="text-align:right">${(c.totalM2||0).toFixed(2)}</th></tr></tfoot>
          </table>
        </div>`;
    }
    function previewChantier(c){
      const w = window.open('','_blank');
      w.document.write(`<html><head><title>Fiche ${escapeHtml(c.name)}</title><meta charset='utf-8'><style>body{font-family:system-ui;line-height:1.45;padding:24px}</style></head><body>${renderChantierHtml(c)}</body></html>`);
      w.document.close();
    }
    function printChantier(){
      const c = {
        name: document.getElementById('chName').value.trim()||'Chantier',
        client: document.getElementById('chClient').value.trim(),
        address: document.getElementById('chAddress').value.trim(),
        contact: document.getElementById('chContact').value.trim()||'Sylvain Garreau',
        chef: document.getElementById('chChef').value.trim(),
        phone: document.getElementById('chPhone').value.trim(),
        works: collectWorks(),
        totalM2: parseFloat(document.getElementById('worksTotal').textContent)||0,
      };
      printHtml(renderChantierHtml(c), `Fiche chantier ‚Äì ${c.name}`);
    }

    // --- Printing & export helpers ---
    function printCurrent(){ window.print(); }
    function printHtml(html, title){
      const w = window.open('', '_blank');
      const css = `@media print { body{margin:0} } body{font-family:system-ui;line-height:1.45;padding:24px}`;
      w.document.write(`<html><head><meta charset='utf-8'><title>${escapeHtml(title)}</title><style>${css}</style></head><body>${html}</body></html>`);
      w.document.close();
      try { w.focus(); } catch(e){}
      // Log before print for reliability
      logDoc('print', title);
      w.print();
    }
    function exportAsHtml(html, filename){
      const blob = new Blob([`<!doctype html><meta charset='utf-8'>${html}`], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
      logDoc('export', filename);
    }

    // --- Documents DB (IndexedDB) ---
    let db; const DB_NAME='GestionAppV72'; const STORE='docs';
    function openDb(){
      return new Promise((resolve,reject)=>{
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = (e)=>{
          const db = e.target.result;
          if(!db.objectStoreNames.contains(STORE)){
            const store = db.createObjectStore(STORE, {keyPath:'id', autoIncrement:true});
            store.createIndex('createdAt','createdAt');
          }
        };
        req.onsuccess = ()=>{ db=req.result; resolve(db); };
        req.onerror = ()=>reject(req.error);
      });
    }
    async function withStore(mode, fn){
      if(!db) await openDb();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(STORE, mode);
        const st = tx.objectStore(STORE);
        const res = fn(st);
        tx.oncomplete = ()=>resolve(res);
        tx.onerror = ()=>reject(tx.error);
      });
    }
    async function importDocs(){
      const inp = document.getElementById('docImport');
      const files = [...(inp.files||[])]; if(!files.length){ alert('S√©lectionnez des fichiers.'); return; }
      await withStore('readwrite', (st)=>{
        files.forEach(f=>{
          const rec = { name:f.name, type:f.type||'application/octet-stream', size:f.size, createdAt:Date.now(), blob:f };
          st.add(rec);
        });
      });
      inp.value='';
      refreshDocs();
    }
    async function refreshDocs(){
      const tbody = document.querySelector('#docsTable tbody'); tbody.innerHTML='';
      await withStore('readonly', (st)=>{
        const idx = st.index('createdAt');
        const req = idx.openCursor(null, 'prev');
        req.onsuccess = ()=>{
          const cur = req.result; if(cur){
            const d = cur.value;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${escapeHtml(d.name)}</td><td>${escapeHtml(d.type||'-')}</td><td class='num'>${fmtSize(d.size)}</td><td>${fmtDate(d.createdAt)}</td><td class='no-print'></td>`;
            const td = tr.querySelector('td.no-print');
            td.appendChild(mkBtn('T√©l√©charger',()=>downloadDoc(d.id)));
            td.appendChild(mkBtn('Suppr',()=>deleteDoc(d.id)));
            tbody.appendChild(tr);
            cur.continue();
          }
        };
      });
    }
    async function downloadDoc(id){
      await withStore('readonly', (st)=>{
        const req = st.get(id);
        req.onsuccess = ()=>{
          const d = req.result; if(!d) return;
          const url = URL.createObjectURL(d.blob);
          const a = document.createElement('a'); a.href=url; a.download=d.name; a.click();
          setTimeout(()=>URL.revokeObjectURL(url),1500);
        };
      });
    }
    async function deleteDoc(id){
      if(!confirm('Supprimer ce document import√© ?')) return;
      await withStore('readwrite', st=>st.delete(id));
      refreshDocs();
    }

    // --- Document logs (prints/exports) ---
    const logsKey='docLogsV72';
    function getLogs(){ return JSON.parse(localStorage.getItem(logsKey)||'[]'); }
    function setLogs(v){ localStorage.setItem(logsKey, JSON.stringify(v)); refreshDocLogs(); }
    function logDoc(kind, title){
      const arr=getLogs(); arr.unshift({id:crypto.randomUUID(), kind, title, at:Date.now()}); setLogs(arr.slice(0,500));
    }
    function refreshDocLogs(){
      const tbody = document.querySelector('#docLogsTable tbody'); tbody.innerHTML='';
      getLogs().forEach(l=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${fmtDate(l.at)}</td><td>${l.kind==='print'?'Impression':'Export'}</td><td>${escapeHtml(l.title||'')}</td>`;
        tbody.appendChild(tr);
      });
    }

    // --- Utils ---
    function mkBtn(label, fn){ const b=document.createElement('button'); b.textContent=label; b.onclick=fn; return b; }
    function sanitize(s){ return (s||'').replace(/[<>]/g,''); }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    function nl2br(s){ return (s||'').replace(/\n/g,'<br>'); }
    function slug(s){ return (s||'').toLowerCase().normalize('NFD').replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'-'); }
    function fmtSize(n){ if(n<1024) return n+' o'; if(n<1024*1024) return (n/1024).toFixed(1)+' Ko'; if(n<1024*1024*1024) return (n/1024/1024).toFixed(1)+' Mo'; return (n/1024/1024/1024).toFixed(1)+' Go'; }
    function pad(n){ return String(n).padStart(2,'0'); }
    function fmtDate(ts){ const d=new Date(ts); return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }

    // Init
    window.addEventListener('load', async ()=>{
      await openDb();
      go(lastRoute);
    });
  </script>
</body>
</html>
