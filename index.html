<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion Chantier ‚Äì V8</title>
  <!--
    Application compl√®te de gestion de chantiers (V8).
    Cette version regroupe les fonctionnalit√©s demand√©es¬†:
    ‚Äì Navigation lat√©rale toujours visible
    ‚Äì Accueil avec r√©sum√© de la derni√®re r√©union et informations pertinentes
    ‚Äì Gestion des r√©unions (cr√©ation et historique)
    ‚Äì Gestion des chantiers avec formulaire complet et enregistrement
    ‚Äì Pages Travaux et Planning (s√©lection de chantier, t√¢ches et planning simples)
    ‚Äì Tableau de bord financier complet bas√© sur V7.4, adapt√© dynamiquement aux chantiers
    ‚Äì Gestion documentaire (import de fichiers et association √† un chantier)
    ‚Äì Param√®tres (seuils d‚Äôalerte et purge des donn√©es)

    Toutes les donn√©es sont stock√©es dans le localStorage du navigateur.
    Chaque section est cach√©e/affich√©e en fonction de la navigation.
  -->
  <style>
    /* Couleurs et variables globales */
    :root {
      --primary-red: #dc2626;
      --primary-orange: #ff6600;
      --success: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;
      --info: #2563eb;
      --bg: #f7fafc;
      --white: #ffffff;
      --border: #e5e7eb;
      --muted: #6b7280;
      --text: #111827;
      --shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
    .app { display: flex; min-height: 100vh; }
    /* Barre lat√©rale fixe */
    .sidebar {
      width: 240px;
      background: var(--white);
      border-right: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 20px;
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      overflow-y: auto;
    }
    .sidebar h2 {
      margin-top: 0;
      font-size: 1.4rem;
      color: var(--primary-red);
    }
    .nav-item {
      display: block;
      padding: 0.6rem 1rem;
      border-radius: 0.6rem;
      margin-bottom: 0.35rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: background 0.2s;
    }
    .nav-item:hover {
      background: var(--border);
    }
    .nav-item.active {
      background: linear-gradient(135deg, var(--primary-red), var(--primary-orange));
      color: var(--white);
    }
    /* Contenu principal */
    .content {
      margin-left: 240px;
      padding: 20px;
      flex: 1;
    }
    .page { display: none; }
    .page.active { display: block; }
    h1 { margin-top: 0; color: var(--primary-red); }
    h2 { margin-top: 0; }
    /* Formulaires et tableaux */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .f { display: flex; flex-direction: column; gap: 6px; }
    .f label { font-weight: 700; font-size: 0.85rem; color: #374151; }
    .f input, .f select, .f textarea {
      border: 2px solid var(--border);
      border-radius: 0.6rem;
      padding: 0.55rem 0.75rem;
      font-size: 1rem;
      background: var(--white);
    }
    .f input:focus, .f select:focus, .f textarea:focus {
      outline: none;
      border-color: var(--primary-red);
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.12);
    }
    .col-3 { grid-column: span 3; }
    .col-4 { grid-column: span 4; }
    .col-6 { grid-column: span 6; }
    .col-12 { grid-column: span 12; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
    thead th { background: linear-gradient(135deg, var(--primary-red), var(--primary-orange)); color: var(--white); text-align: left; }
    td.num, th.num { text-align: right; }
    tr:hover td { background: #fafafa; }
    .btn { display: inline-flex; align-items: center; gap: 0.5rem; border-radius: 0.6rem; padding: 0.65rem 1rem; border: 2px solid transparent; font-weight: 700; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.06); transition: 0.15s background, 0.15s transform; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary-red); color: var(--white); }
    .btn-secondary { background: #eef2f7; color: var(--text); border-color: #d1d5db; }
    .btn-danger { background: var(--danger); color: var(--white); }
    /* Alertes */
    .alert { padding: 10px 12px; border-radius: 0.8rem; border: 1px solid; margin-bottom: 8px; font-weight: 700; }
    .alert.ok { border-color: var(--success); color: var(--success); background: rgba(16,185,129,0.08); }
    .alert.warn { border-color: var(--warn); color: var(--warn); background: rgba(245,158,11,0.1); }
    .alert.cr { border-color: var(--danger); color: var(--danger); background: rgba(239,68,68,0.1); }
    /* Tableau de bord √©l√©ments */
    .card { background: var(--white); border: 1px solid var(--border); border-radius: 1rem; box-shadow: var(--shadow); padding: 16px; margin-bottom: 16px; }
    .card h3 { margin: 0 0 10px 0; }
    .kpis { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .k { grid-column: span 3; background: var(--white); border: 1px solid var(--border); border-radius: 1rem; padding: 14px; text-align: center; position: relative; overflow: hidden; }
    .k::before { content: ""; position: absolute; inset: 0 0 auto 0; height: 4px; background: linear-gradient(90deg, var(--primary-red), var(--primary-orange)); }
    .k h4 { font-size: 0.8rem; color: var(--muted); margin: 0 0 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .k .v { font-size: 1.6rem; font-weight: 800; margin: 2px 0; }
    .v.pos { color: var(--success); }
    .v.neg { color: var(--danger); }
    .v.neu { color: var(--primary-red); }
    .trend { font-size: 0.78rem; color: var(--muted); }
    .progress { margin-top: 10px; border-radius: 0.5rem; background: #eef2f7; height: 10px; overflow: hidden; }
    .bar { height: 100%; background: linear-gradient(90deg, var(--primary-red), var(--primary-orange)); width: 0; transition: width 0.8s; }
    .legend { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px; font-size: 0.85rem; }
    .dot { width: 0.8rem; height: 0.8rem; border-radius: 50%; display: inline-block; }
    /* Pages sp√©cifiques */
    #surfTable th, #surfTable td { text-align: left; }
    .mini { font-size: 0.78rem; color: var(--muted); margin-top: -2px; }
    /* Grille pour l'accueil : derni√®re r√©union / infos pertinentes / prochaine r√©union */
    .home-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }
    @media (max-width: 900px) {
      .home-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Barre lat√©rale de navigation -->
    <aside class="sidebar">
      <h2>üõ†Ô∏è Gestion Chantier</h2>
      <nav>
        <span class="nav-item active" data-page="accueil">Accueil</span>
        <span class="nav-item" data-page="reunions">R√©unions</span>
        <!-- Renomm√© pour indiquer la cr√©ation d'un nouveau chantier -->
        <span class="nav-item" data-page="chantiers">Nouveau chantier</span>
        <span class="nav-item" data-page="travaux">Travaux</span>
        <span class="nav-item" data-page="tableau">Tableau</span>
        <span class="nav-item" data-page="planning">Planning</span>
        <span class="nav-item" data-page="documents">Documents</span>
        <span class="nav-item" data-page="parametres">Param√®tres</span>
      </nav>
    </aside>
    <!-- Contenu principal -->
    <main class="content">
      <!-- Accueil -->
      <section id="accueil" class="page active">
        <h1>Accueil</h1>
        <!-- Grille pour derni√®re r√©union, prochaine r√©union et informations pertinentes -->
        <div class="home-grid">
          <div class="card" id="lastReunionCard">
            <h3>üìù Derni√®re r√©union</h3>
            <div id="lastReunionContent">Aucune r√©union enregistr√©e.</div>
          </div>
          <div class="card" id="infoPertinentes">
            <h3>‚ÑπÔ∏è Informations pertinentes</h3>
            <div>
              <h4>Personnes en cong√©s</h4>
              <ul id="listConges"></ul>
              <h4>Personnes en arr√™t maladie</h4>
              <ul id="listMaladie"></ul>
              <h4>Stocks √† pr√©voir</h4>
              <ul id="listStocks"></ul>
              <h4>Commandes √† passer</h4>
              <ul id="listCommandes"></ul>
            </div>
          </div>
          <div class="card" id="nextReunionCard">
            <h3>üìÖ Prochaine r√©union</h3>
            <div id="nextReunionContent">Aucune r√©union √† venir.</div>
          </div>
        </div>
        <div class="card" id="listeChantiersAccueil">
          <h3>üèóÔ∏è Chantiers en cours</h3>
          <div id="accueilChantiers"></div>
        </div>
      </section>
      <!-- R√©unions -->
      <section id="reunions" class="page">
        <h1>R√©unions</h1>
        <div class="card">
          <h3>Nouvelle r√©union</h3>
          <form id="reunionForm">
            <div class="form-grid">
              <div class="f col-4">
                <label>Date</label>
                <input id="reunionDate" type="date" required>
              </div>
              <div class="f col-4">
                <label>Th√®me</label>
                <input id="reunionTheme" type="text" required>
              </div>
              <div class="f col-4">
                <label>Chantier associ√©</label>
                <select id="reunionChantier"></select>
              </div>
              <div class="f col-12">
                <label>Compte rendu</label>
                <textarea id="reunionNotes" rows="4" required></textarea>
              </div>
              <div class="f col-12">
                <button type="submit" class="btn btn-primary">Enregistrer la r√©union</button>
              </div>
            </div>
          </form>
        </div>
        <div class="card">
          <h3>Historique des r√©unions</h3>
          <div id="reunionList"></div>
        </div>
      </section>
      <!-- Chantiers -->
      <section id="chantiers" class="page">
        <h1>Nouveau chantier</h1>
        <div class="card">
          <h3>Nouveau chantier</h3>
          <form id="chantierForm">
            <div class="form-grid">
              <div class="f col-6">
                <label>Nom du chantier</label>
                <input id="chantierName" type="text" required>
              </div>
              <div class="f col-6">
                <label>Lieu</label>
                <input id="chantierLieu" type="text">
              </div>
              <div class="f col-4">
                <label>Contact principal</label>
                <input id="chantierContact" type="text" value="Sylvain Garreau">
              </div>
              <div class="f col-4">
                <label>Chef de chantier (optionnel)</label>
                <input id="chantierChef" type="text" placeholder="Nom du chef">
              </div>
              <div class="f col-4">
                <label>Date de d√©but</label>
                <input id="chantierDebut" type="date">
              </div>
              <div class="col-12">
                <label>Types de travaux et surfaces (m¬≤)</label>
                <table id="surfTable">
                  <thead><tr><th>Type de travaux</th><th>Surface (m¬≤)</th><th></th></tr></thead>
                  <tbody id="surfBody"></tbody>
                </table>
                <button type="button" class="btn btn-secondary" id="addSurfaceRow">Ajouter un type</button>
              </div>
              <div class="f col-12">
                <button type="submit" class="btn btn-primary">Enregistrer le chantier</button>
              </div>
            </div>
          </form>
        </div>
        <div class="card">
          <h3>Liste des chantiers</h3>
          <div id="chantierList"></div>
        </div>
      </section>
      <!-- Travaux -->
      <section id="travaux" class="page">
        <h1>Travaux</h1>
        <div class="card">
          <h3>S√©lectionner un chantier</h3>
          <select id="travauxChantier"></select>
        </div>
        <div class="card">
          <h3>Liste des travaux / t√¢ches</h3>
          <div id="travauxContent">S√©lectionnez un chantier pour afficher les travaux.</div>
        </div>
      </section>
      <!-- Tableau de bord financier -->
      <section id="tableau" class="page">
        <h1>Tableau de bord financier</h1>
        <div class="card">
          <h3>S√©lectionner un chantier</h3>
          <select id="tableauChantier"></select>
        </div>
        <!-- Contenu du tableau de bord (adapt√© de V7.4) -->
        <div id="tableauContent"></div>
      </section>
      <!-- Planning -->
      <section id="planning" class="page">
        <h1>Planning</h1>
        <div class="card">
          <h3>S√©lectionner un chantier</h3>
          <select id="planningChantier"></select>
        </div>
        <div class="card">
          <h3>Planning des t√¢ches</h3>
          <div id="planningContent">S√©lectionnez un chantier pour afficher le planning.</div>
        </div>
      </section>
      <!-- Documents -->
      <section id="documents" class="page">
        <h1>Documents</h1>
        <div class="card">
          <h3>Importer des documents</h3>
          <input id="fileImport" type="file" multiple accept="application/pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
        </div>
        <div class="card">
          <h3>Liste des documents</h3>
          <div id="documentList"></div>
        </div>
      </section>
      <!-- Param√®tres -->
      <section id="parametres" class="page">
        <h1>Param√®tres</h1>
        <div class="card">
          <h3>Seuil d‚Äôalerte budget (%)</h3>
          <input id="alertThreshold" type="number" min="50" max="100" value="80">
        </div>
        <div class="card">
          <h3>Actions</h3>
          <button id="purgeData" class="btn btn-danger">Purger toutes les donn√©es</button>
        </div>
      </section>
    </main>
  </div>
<script>
/* ---------- Donn√©es initiales et utilitaires ---------- */
// Structures de base pour localStorage
function loadChantiers() {
  return JSON.parse(localStorage.getItem('chantiers') || '[]');
}
function saveChantiers(chantiers) {
  localStorage.setItem('chantiers', JSON.stringify(chantiers));
}
function loadReunions() {
  return JSON.parse(localStorage.getItem('reunions') || '[]');
}
function saveReunions(reunions) {
  localStorage.setItem('reunions', JSON.stringify(reunions));
}
function loadDocs() {
  return JSON.parse(localStorage.getItem('documents') || '[]');
}
function saveDocs(docs) {
  localStorage.setItem('documents', JSON.stringify(docs));
}
// Formatage
const FR = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
const PCT = v => `${Math.round(v || 0)}%`;
const clamp = (v,a,b) => Math.min(b, Math.max(a, v || 0));
function genId() { return Date.now().toString(36) + Math.random().toString(36).substring(2); }

/* ---------- Navigation ---------- */
function openPage(pageId) {
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.toggle('active', item.dataset.page === pageId);
  });
  document.querySelectorAll('.page').forEach(page => {
    page.classList.toggle('active', page.id === pageId);
  });
  // Si on ouvre le tableau ou travaux ou planning, rafra√Æchir les s√©lecteurs
  if(pageId === 'travaux') renderTravauxPage();
  if(pageId === 'tableau') renderTableauPage();
  if(pageId === 'planning') renderPlanningPage();
  if(pageId === 'reunions') renderReunionsPage();
}
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => openPage(item.dataset.page));
});

/* ---------- Accueil ---------- */
function renderAccueil() {
  // Derni√®re r√©union
  const reunions = loadReunions();
  const last = reunions.length ? reunions[reunions.length - 1] : null;
  const lastDiv = document.getElementById('lastReunionContent');
  if(last) {
    // Utilisation d'un tiret simple √† la place du tiret semi-cadratin pour compatibilit√©
    lastDiv.innerHTML = `<strong>${last.theme}</strong> - ${new Date(last.date).toLocaleDateString('fr-FR')}<br>${last.notes.replace(/\n/g, '<br>')}`;
  } else {
    lastDiv.textContent = 'Aucune r√©union enregistr√©e.';
  }
  // Personnes en cong√©s / maladie (donn√©es statiques pour l'exemple)
  const conges = JSON.parse(localStorage.getItem('conges') || '["Alice","Patrick"]');
  const maladie = JSON.parse(localStorage.getItem('maladie') || '["Julien"]');
  const stocks = JSON.parse(localStorage.getItem('stocks') || '["Peinture","Plomberie"]');
  const commandes = JSON.parse(localStorage.getItem('commandes') || '["Ciment","Tuiles"]');
  const ulConges = document.getElementById('listConges'); ulConges.innerHTML = '';
  conges.forEach(n => { const li=document.createElement('li'); li.textContent=n; ulConges.appendChild(li); });
  const ulMal = document.getElementById('listMaladie'); ulMal.innerHTML = '';
  maladie.forEach(n => { const li=document.createElement('li'); li.textContent=n; ulMal.appendChild(li); });
  const ulStocks = document.getElementById('listStocks'); ulStocks.innerHTML = '';
  stocks.forEach(n => { const li=document.createElement('li'); li.textContent=n; ulStocks.appendChild(li); });
  const ulComm = document.getElementById('listCommandes'); ulComm.innerHTML = '';
  commandes.forEach(n => { const li=document.createElement('li'); li.textContent=n; ulComm.appendChild(li); });
  // Prochaine r√©union globale
  const now = new Date();
  let upcoming = null;
  reunions.forEach(r => {
    const d = new Date(r.date);
    if(d > now && (!upcoming || d < new Date(upcoming.date))) {
      upcoming = r;
    }
  });
  const nextDiv = document.getElementById('nextReunionContent');
  if(upcoming) {
    const chantierName = loadChantiers().find(c => c.id === upcoming.chantier)?.name || '‚Äî';
    const notes = upcoming.notes ? upcoming.notes.split('\n')[0] : '';
    nextDiv.innerHTML = `<strong>${upcoming.theme}</strong> - ${new Date(upcoming.date).toLocaleDateString('fr-FR')}<br>` +
                        `Chantier¬†: ${chantierName}<br>` +
                        `${notes}`;
  } else {
    nextDiv.textContent = 'Aucune r√©union √† venir.';
  }
  // Liste des chantiers avec avancement
  const chs = loadChantiers();
  const container = document.getElementById('accueilChantiers');
  container.innerHTML = '';
  if(chs.length === 0) {
    container.textContent = 'Aucun chantier enregistr√©.';
  } else {
    chs.forEach(c => {
      // Calcul de l'avancement bas√© sur les surfaces r√©alis√©es vs pr√©vues
      const surfaces = c.surfaces || [];
      const totalArea = surfaces.reduce((s, it) => s + (it.area || 0), 0);
      const realizedArea = surfaces.reduce((s, it) => s + (it.realized || 0), 0);
      const progress = totalArea > 0 ? (realizedArea / totalArea) : 0;
      // Prochaine r√©union pour ce chantier
      let nextForChantier = null;
      reunions.forEach(r => {
        if(r.chantier === c.id) {
          const d = new Date(r.date);
          if(d > now && (!nextForChantier || d < new Date(nextForChantier.date))) {
            nextForChantier = r;
          }
        }
      });
      const nextInfo = nextForChantier ? `${new Date(nextForChantier.date).toLocaleDateString('fr-FR')} - ${nextForChantier.theme}` : '‚Äî';
      const item = document.createElement('div');
      item.style.padding = '10px 12px';
      item.style.border = '1px solid var(--border)';
      item.style.borderRadius = '0.6rem';
      item.style.marginBottom = '8px';
      item.style.cursor = 'pointer';
      // Contenu HTML du chantier avec avancement et prochaine r√©union
      item.innerHTML = `
        <div style="display:flex; justify-content: space-between; align-items: center; gap: 8px;">
          <div style="flex:1;">
            <strong>${c.name}</strong> - ${c.lieu || ''}<br>
            <small>Prochaine r√©union&nbsp;: ${nextInfo}</small>
          </div>
          <div style="width: 140px;">
            <div class="progress" style="height: 8px;">
              <div class="bar" style="height: 8px; width: ${(progress * 100).toFixed(0)}%;"></div>
            </div>
            <small>${(progress * 100).toFixed(0)}%</small>
          </div>
        </div>`;
      item.addEventListener('click', () => {
        localStorage.setItem('currentChantier', c.id);
        openPage('tableau');
      });
      container.appendChild(item);
    });
  }
}

/* ---------- R√©unions ---------- */
function renderReunionsPage() {
  // Remplir s√©lecteur de chantier
  const sel = document.getElementById('reunionChantier');
  sel.innerHTML = '<option value="">‚Äî Aucun ‚Äî</option>';
  loadChantiers().forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    sel.appendChild(opt);
  });
  // Liste des r√©unions
  const listDiv = document.getElementById('reunionList');
  const reunions = loadReunions();
  if(reunions.length === 0) {
    listDiv.textContent = 'Aucune r√©union enregistr√©e.';
  } else {
    listDiv.innerHTML = '';
    reunions.forEach(r => {
      const card = document.createElement('div');
      card.style.border = '1px solid var(--border)';
      card.style.borderRadius = '0.6rem';
      card.style.padding = '8px 10px';
      card.style.marginBottom = '6px';
      const chantier = loadChantiers().find(c => c.id === r.chantier);
      card.innerHTML = `<strong>${r.theme}</strong> - ${new Date(r.date).toLocaleDateString('fr-FR')}<br>Chantier¬†: ${chantier ? chantier.name : '‚Äî'}<br>${r.notes.replace(/\n/g,'<br>')}`;
      listDiv.appendChild(card);
    });
  }
}
// Soumission du formulaire de r√©union
document.getElementById('reunionForm').addEventListener('submit', e => {
  e.preventDefault();
  const date = document.getElementById('reunionDate').value;
  const theme = document.getElementById('reunionTheme').value.trim();
  const chantier = document.getElementById('reunionChantier').value || null;
  const notes = document.getElementById('reunionNotes').value.trim();
  const reunions = loadReunions();
  reunions.push({ id: genId(), date, theme, chantier, notes });
  saveReunions(reunions);
  document.getElementById('reunionForm').reset();
  renderReunionsPage();
  renderAccueil();
});

/* ---------- Gestion des chantiers ---------- */
// Ajouter une ligne de saisie de surface
function addSurfaceRow(type = '', area = '') {
  const tbody = document.getElementById('surfBody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td><input type="text" class="typeTrav" value="${type}"></td>` +
                 `<td><input type="number" class="surfaceTrav" min="0" step="0.1" value="${area}"></td>` +
                 `<td><button type="button" class="btn btn-secondary btn-sm removeRow">‚úñ</button></td>`;
  tbody.appendChild(tr);
  tr.querySelector('.removeRow').addEventListener('click', () => tr.remove());
}
document.getElementById('addSurfaceRow').addEventListener('click', () => addSurfaceRow());
// Soumission du formulaire de chantier
document.getElementById('chantierForm').addEventListener('submit', e => {
  e.preventDefault();
  const name = document.getElementById('chantierName').value.trim();
  const lieu = document.getElementById('chantierLieu').value.trim();
  const contact = document.getElementById('chantierContact').value.trim();
  const chef = document.getElementById('chantierChef').value.trim() || null;
  const debut = document.getElementById('chantierDebut').value || null;
  // Surfaces
  const surfaces = [];
    document.querySelectorAll('#surfBody tr').forEach(tr => {
    const type = tr.querySelector('.typeTrav').value.trim();
    const area = parseFloat(tr.querySelector('.surfaceTrav').value);
    // On enregistre aussi une valeur r√©alis√©e par d√©faut (0) pour permettre le suivi d'avancement
    if(type && !isNaN(area) && area > 0) surfaces.push({ type, area, realized: 0 });
  });
  // Calcul budgets basiques (peu r√©aliste mais suffisant) : on utilise un co√ªt/m¬≤ fictif
  const totalM2 = surfaces.reduce((sum, s) => sum + s.area, 0);
  const bMO = totalM2 * 30;   // main d'≈ìuvre interne
  const bST = totalM2 * 20;   // sous-traitance
  const bF  = totalM2 * 50;   // fournitures & mat√©riel
  const bL  = totalM2 * 10;   // locations
  const devis = (bMO + bST + bF + bL) * 1.3; // devis (prix de vente) arbitraire 30% marge
  const newCh = { id: genId(), name, lieu, contact, chef, debut, surfaces, budgets: { bMO, bST, bF, bL }, devis };
  const chantiers = loadChantiers();
  chantiers.push(newCh);
  saveChantiers(chantiers);
  document.getElementById('chantierForm').reset();
  document.getElementById('surfBody').innerHTML = '';
  renderChantiersList();
  renderAccueil();
});
function renderChantiersList() {
  const listDiv = document.getElementById('chantierList');
  const chs = loadChantiers();
  if(chs.length === 0) {
    listDiv.textContent = 'Aucun chantier enregistr√©.';
  } else {
    listDiv.innerHTML = '';
    chs.forEach(c => {
      const div = document.createElement('div');
      div.style.border = '1px solid var(--border)';
      div.style.borderRadius = '0.6rem';
      div.style.padding = '8px 10px';
      div.style.marginBottom = '6px';
      // Surface totale prot√©g√©e contre l'absence de surfaces
      div.innerHTML = `<strong>${c.name}</strong><br>` +
                      `Lieu¬†: ${c.lieu || '‚Äî'}<br>` +
                      `Contact¬†: ${c.contact || '‚Äî'}<br>` +
                      `Chef¬†: ${c.chef || '‚Äî'}<br>` +
                      `Surfaces¬†: ${ (c.surfaces || []).reduce((s, it) => s + (it.area || 0), 0) } m¬≤`;
      div.addEventListener('click', () => {
        localStorage.setItem('currentChantier', c.id);
        openPage('tableau');
      });
      listDiv.appendChild(div);
    });
  }
}

/* ---------- Travaux ---------- */
function renderTravauxPage() {
  const sel = document.getElementById('travauxChantier');
  sel.innerHTML = '<option value="">‚Äî S√©lectionner ‚Äî</option>';
  const chs = loadChantiers();
  chs.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    sel.appendChild(opt);
  });
  // Pr√©-s√©lectionner le chantier courant
  const current = localStorage.getItem('currentChantier') || '';
  sel.value = current;
  renderTravauxContent();
  sel.onchange = () => {
    localStorage.setItem('currentChantier', sel.value);
    renderTravauxContent();
  };
}
function renderTravauxContent() {
  const cid = document.getElementById('travauxChantier').value;
  const content = document.getElementById('travauxContent');
  if(!cid) {
    content.textContent = 'S√©lectionnez un chantier pour afficher les travaux.';
    return;
  }
  const chantier = loadChantiers().find(c => c.id === cid);
  if(!chantier) {
    content.textContent = 'Chantier introuvable.';
    return;
  }
  if(chantier.surfaces.length === 0) {
    content.textContent = 'Aucune t√¢che d√©finie.';
    return;
  }
  const table = document.createElement('table');
  table.innerHTML = '<thead><tr><th>Type de travaux</th><th class="num">Surface (m¬≤)</th><th class="num">Heures planifi√©es</th><th class="num">Heures r√©alis√©es</th></tr></thead>';
  const tbody = document.createElement('tbody');
  chantier.surfaces.forEach(s => {
    const row = document.createElement('tr');
    const planned = (s.area * 0.5).toFixed(1); // heuristique : 0,5 h par m2
    const realized = (s.realized || 0).toFixed(1);
    row.innerHTML = `<td>${s.type}</td><td class="num">${s.area}</td><td class="num">${planned}</td><td class="num">${realized}</td>`;
    tbody.appendChild(row);
  });
  table.appendChild(tbody);
  content.innerHTML = '';
  content.appendChild(table);
}

/* ---------- Planning ---------- */
function renderPlanningPage() {
  const sel = document.getElementById('planningChantier');
  sel.innerHTML = '<option value="">‚Äî S√©lectionner ‚Äî</option>';
  const chs = loadChantiers();
  chs.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    sel.appendChild(opt);
  });
  const current = localStorage.getItem('currentChantier') || '';
  sel.value = current;
  renderPlanningContent();
  sel.onchange = () => {
    localStorage.setItem('currentChantier', sel.value);
    renderPlanningContent();
  };
}
function renderPlanningContent() {
  const cid = document.getElementById('planningChantier').value;
  const content = document.getElementById('planningContent');
  if(!cid) {
    content.textContent = 'S√©lectionnez un chantier pour afficher le planning.';
    return;
  }
  const chantier = loadChantiers().find(c => c.id === cid);
  if(!chantier) {
    content.textContent = 'Chantier introuvable.';
    return;
  }
  // G√©n√©rer un planning simple : chaque t√¢che = 1 jour
  // Utiliser la date de d√©but du chantier si elle est valide, sinon aujourd'hui
  let currentDate = chantier.debut ? new Date(chantier.debut) : new Date();
  if(isNaN(currentDate.getTime())) currentDate = new Date();
  const table = document.createElement('table');
  table.innerHTML = '<thead><tr><th>T√¢che</th><th>D√©but</th><th>Fin</th></tr></thead>';
  const tbody = document.createElement('tbody');
  chantier.surfaces.forEach(s => {
    const start = new Date(currentDate);
    const end = new Date(start);
    end.setDate(end.getDate() + 1);
    const row = document.createElement('tr');
    row.innerHTML = `<td>${s.type}</td><td>${start.toLocaleDateString('fr-FR')}</td><td>${end.toLocaleDateString('fr-FR')}</td>`;
    tbody.appendChild(row);
    currentDate = end;
  });
  table.appendChild(tbody);
  content.innerHTML = '';
  content.appendChild(table);
}

/* ---------- Documents ---------- */
// Import de fichiers et liste
document.getElementById('fileImport').addEventListener('change', e => {
  const files = e.target.files;
  const docs = loadDocs();
  Array.from(files).forEach(f => {
    const reader = new FileReader();
    reader.onload = () => {
      const id = genId();
      docs.push({ id, name: f.name, data: reader.result, chantier: localStorage.getItem('currentChantier') || null });
      saveDocs(docs);
      renderDocuments();
    };
    reader.readAsDataURL(f);
  });
});
function renderDocuments() {
  const container = document.getElementById('documentList');
  const docs = loadDocs();
  if(docs.length === 0) {
    container.textContent = 'Aucun document import√©.';
    return;
  }
  container.innerHTML = '';
  docs.forEach(doc => {
    const div = document.createElement('div');
    div.style.border = '1px solid var(--border)';
    div.style.borderRadius = '0.6rem';
    div.style.padding = '8px 10px';
    div.style.marginBottom = '6px';
    const chantier = loadChantiers().find(c => c.id === doc.chantier);
    div.innerHTML = `<strong>${doc.name}</strong><br>Chantier¬†: ${chantier ? chantier.name : '‚Äî'}<br>` +
                    `<a href="${doc.data}" download="${doc.name}">T√©l√©charger</a>`;
    container.appendChild(div);
  });
}

/* ---------- Infos chantier (tableau de bord) ---------- */
function renderInfosChantier() {
  const container = document.getElementById('infosChantier');
  if(!container) return;
  const cid = localStorage.getItem('currentChantier');
  const chantier = loadChantiers().find(c => c.id === cid);
  if(!chantier) {
    container.innerHTML = '<h3>üîç Infos chantier</h3><p>Aucun chantier s√©lectionn√©.</p>';
    return;
  }
  const totalArea = (chantier.surfaces || []).reduce((s,it) => s + (it.area || 0), 0);
  const details = (chantier.surfaces || []).map(s => `${s.type}: ${s.area} m¬≤`).join('<br>');
  container.innerHTML = `
    <h3>üîé Infos chantier</h3>
    <p><strong>Nom :</strong> ${chantier.name}<br>
    <strong>Lieu :</strong> ${chantier.lieu || '‚Äî'}<br>
    <strong>Contact :</strong> ${chantier.contact || '‚Äî'}<br>
    <strong>Chef :</strong> ${chantier.chef || '‚Äî'}<br>
    <strong>Date de d√©but :</strong> ${chantier.debut ? new Date(chantier.debut).toLocaleDateString('fr-FR') : '‚Äî'}<br>
    <strong>Surface totale :</strong> ${totalArea} m¬≤<br>
    <strong>D√©tails par type :</strong><br>${details || '‚Äî'}</p>
  `;
}

/* ---------- Param√®tres ---------- */
document.getElementById('purgeData').addEventListener('click', () => {
  if(confirm('√ätes-vous s√ªr de vouloir supprimer toutes les donn√©es ?')) {
    localStorage.clear();
    renderAccueil();
    renderChantiersList();
    renderReunionsPage();
    renderDocuments();
    // R√©initialiser seuil d‚Äôalerte
    document.getElementById('alertThreshold').value = 80;
    alert('Donn√©es supprim√©es.');
  }
});

/* ---------- Tableau de bord (adapt√© de V7.4) ---------- */
// Gabarit HTML inject√© dans la page tableauContent
const tableauTemplate = `
<div class="card" id="infosChantier"></div>
<div class="card">
  <h3><span class="i">‚öôÔ∏è</span> Param√®tres & Saisie</h3>
  <div class="form-grid">
    <div class="f col-6">
      <label>Co√ªt horaire base (‚Ç¨/h)</label>
      <input id="coutBase" type="number" step="0.1" value="22">
      <div class="mini">Salaire + primes</div>
    </div>
    <div class="f col-6">
      <label>Charges & frais (%)</label>
      <input id="chargesPct" type="number" min="0" max="200" step="1" value="85">
      <div class="mini">Patronales + structure</div>
    </div>
    <div class="f col-6">
      <label>Heures MO r√©alis√©es (h)</label>
      <input id="hReal" type="number" step="0.1" value="0">
    </div>
    <div class="f col-6">
      <label>D√©penses ST (‚Ç¨)</label>
      <input id="depST" type="number" step="0.01" value="0">
    </div>
    <div class="f col-6">
      <label>D√©penses Fournitures (‚Ç¨)</label>
      <input id="depF" type="number" step="0.01" value="0">
    </div>
    <div class="f col-6">
      <label>D√©penses Locations (‚Ç¨)</label>
      <input id="depL" type="number" step="0.01" value="0">
    </div>
    <div class="f col-6">
      <label>Impr√©vus (%)</label>
      <input id="imprevusPct" type="number" step="0.5" min="0" max="30" value="7">
    </div>
    <div class="f col-6">
      <label>M√©thode de pr√©vision</label>
      <select id="method">
        <option value="cpi" selected>CPI (valeur acquise)</option>
        <option value="naive">Na√Øve (budget restant)</option>
      </select>
    </div>
    <div class="f col-6">
      <label>Avancement global (%)</label>
      <input id="avcGlobal" type="number" min="0" max="100" value="0">
      <div class="mini">Utilis√© si les % par cat√©gorie sont vides</div>
    </div>
    <div class="f col-6">
      <label>Avancement MO (%)</label>
      <input id="avcMO" type="number" min="0" max="100" placeholder="">
    </div>
    <div class="f col-6">
      <label>Avancement ST (%)</label>
      <input id="avcST" type="number" min="0" max="100" placeholder="">
    </div>
    <div class="f col-6">
      <label>Avancement Fourn. (%)</label>
      <input id="avcF" type="number" min="0" max="100" placeholder="">
    </div>
    <div class="f col-6">
      <label>Avancement Loc. (%)</label>
      <input id="avcL" type="number" min="0" max="100" placeholder="">
    </div>
  </div>
</div>
<div class="card">
  <h3>üîî Alertes</h3>
  <div class="alerts" id="alerts"></div>
  <div id="notes" class="mini"></div>
</div>
<div class="card">
  <h3>üìã R√©sum√© financier</h3>
  <table>
    <thead>
      <tr><th>Cat√©gorie</th><th class="num">Budg√©t√© (‚Ç¨)</th><th class="num">D√©pens√© (‚Ç¨)</th><th class="num">Reste (‚Ç¨)</th><th class="num">% Utilis√©</th></tr>
    </thead>
    <tbody>
      <tr><td>Main d'≈ìuvre (interne)</td><td class="num" id="bMO">‚Äî</td><td class="num" id="dMO">‚Äî</td><td class="num" id="rMO">‚Äî</td><td class="num" id="pMO">‚Äî</td></tr>
      <tr><td>Sous-traitance</td><td class="num" id="bST">‚Äî</td><td class="num" id="dST">‚Äî</td><td class="num" id="rST">‚Äî</td><td class="num" id="pST">‚Äî</td></tr>
      <tr><td>Fournitures & mat√©riel</td><td class="num" id="bF">‚Äî</td><td class="num" id="dF">‚Äî</td><td class="num" id="rF">‚Äî</td><td class="num" id="pF">‚Äî</td></tr>
      <tr><td>Locations</td><td class="num" id="bL">‚Äî</td><td class="num" id="dL">‚Äî</td><td class="num" id="rL">‚Äî</td><td class="num" id="pL">‚Äî</td></tr>
      <tr class="total"><td>TOTAL Co√ªts directs (BAC)</td><td class="num" id="bTOT">‚Äî</td><td class="num" id="dTOT">‚Äî</td><td class="num" id="rTOT">‚Äî</td><td class="num" id="pTOT">‚Äî</td></tr>
    </tbody>
    <tfoot>
      <tr class="grand"><td colspan="4">EAC - Co√ªt √† terminaison (avec impr√©vus)</td><td class="num" id="EAC">‚Äî</td></tr>
    </tfoot>
  </table>
  <div class="bars" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px;">
    <div class="item">
      <div class="row"><strong>Main d'≈ìuvre</strong><span id="txtPMO">0%</span></div>
      <div class="progress"><div class="bar" id="barMO"></div></div>
    </div>
    <div class="item">
      <div class="row"><strong>Fournitures</strong><span id="txtPF">0%</span></div>
      <div class="progress"><div class="bar" id="barF"></div></div>
    </div>
    <div class="item">
      <div class="row"><strong>Budget global</strong><span id="txtPT">0%</span></div>
      <div class="progress"><div class="bar" id="barTOT"></div></div>
    </div>
    <div class="item" style="text-align: center">
      <svg class="donut" viewBox="0 0 42 42" width="180" height="180">
        <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#e5e7eb" stroke-width="6"></circle>
        <circle id="donut" cx="21" cy="21" r="15.915" fill="transparent" stroke="url(#g)" stroke-width="6" stroke-linecap="round" stroke-dasharray="0 100" transform="rotate(-90 21 21)"></circle>
        <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="0"><stop offset="0" stop-color="#dc2626"></stop><stop offset="1" stop-color="#ff6600"></stop></linearGradient></defs>
        <text id="donutTxt" x="50%" y="50%" text-anchor="middle" dominant-baseline="central" style="font-weight:800;font-size:18px;fill:#111827">0%</text>
      </svg>
      <div class="mini">Budget utilis√© (AC/BAC)</div>
    </div>
  </div>
</div>
<div class="card">
  <h3>üìä KPI</h3>
  <div class="kpis">
    <div class="k"><h4>Prix de vente</h4><div class="v neu" id="kDevis">‚Äî</div><div class="trend">Montant contractuel</div></div>
    <div class="k"><h4>EAC (co√ªt projet√©)</h4><div class="v neu" id="kEAC">‚Äî</div><div class="trend" id="kMethod">M√©thode</div></div>
    <div class="k"><h4>Marge pr√©visionnelle</h4><div class="v" id="kMarge">‚Äî</div><div class="trend" id="kTrend">Performance</div></div>
    <div class="k"><h4>Taux de marge</h4><div class="v" id="kMargePct">‚Äî</div><div class="trend">Rentabilit√©</div></div>
    <div class="k"><h4>CPI</h4><div class="v neu" id="kCPI">‚Äî</div><div class="trend">EV / AC</div></div>
    <div class="k"><h4>SPI (proxy)</h4><div class="v neu" id="kSPI">‚Äî</div><div class="trend">EV / PV</div></div>
  </div>
</div>
<div class="grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
  <div class="card">
    <h3>üì∂ Budg√©t√© vs D√©pens√©</h3>
    <canvas id="chartBars" width="800" height="300" aria-label="Budg√©t√© vs D√©pens√©"></canvas>
    <div class="legend"><span><span class="dot" style="background:#9ca3af"></span>Budg√©t√©</span><span><span class="dot" style="background:#dc2626"></span>D√©pens√©</span></div>
  </div>
  <div class="card">
    <h3>üìà Burn-up (EV, AC, BAC)</h3>
    <canvas id="chartBurn" width="800" height="300" aria-label="Burn-up EV/AC/BAC"></canvas>
    <div class="legend"><span><span class="dot" style="background:#dc2626"></span>AC</span><span><span class="dot" style="background:#ff6600"></span>EV</span><span><span class="dot" style="background:#9ca3af"></span>BAC</span></div>
  </div>
</div>`;

// Fonctions de dessin basiques pour les graphiques (identiques √† V7.4)
function drawBars(canvas, labels, budget, depense) {
  const ctx = canvas.getContext('2d'); const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H); ctx.save(); ctx.translate(50,20);
  const w = W - 70, h = H - 50;
  const max = Math.max(1, ...budget, ...depense);
  ctx.strokeStyle = '#e5e7eb';
  for(let i=0;i<=4;i++) {
    const y = h - (i/4) * h;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
    ctx.fillStyle = '#6b7280'; ctx.font = '12px system-ui';
    ctx.fillText(FR.format((i/4) * max), w + 8, y + 4);
  }
  const n = labels.length; const group = w / n; const bw = Math.min(26, (group - 18) / 2);
  for(let i=0;i<n;i++) {
    const x = i * group + 18;
    const hb = (budget[i]/max) * h; ctx.fillStyle = '#9ca3af'; ctx.fillRect(x, h - hb, bw, hb);
    const hd = (depense[i]/max) * h; ctx.fillStyle = '#dc2626'; ctx.fillRect(x + bw + 8, h - hd, bw, hd);
    ctx.fillStyle = '#374151'; ctx.fillText(labels[i], x - 4, h + 16);
  }
  ctx.restore();
}
function drawBurn(canvas, AC, EV, BAC) {
  const ctx = canvas.getContext('2d'); const W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H); ctx.save(); ctx.translate(40,20);
  const w=W-60, h=H-50;
  const max = Math.max(BAC, AC*1.1, EV*1.1, 1);
  ctx.strokeStyle='#e5e7eb';
  for(let i=0;i<=4;i++){
    const y = h - (i/4)*h;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
    ctx.fillStyle='#6b7280'; ctx.font='12px system-ui';
    ctx.fillText(FR.format((i/4)*max), w+8, y+4);
  }
  // BAC line
  ctx.strokeStyle='#9ca3af'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(0, h - (BAC/max)*h);
  ctx.lineTo(w, h - (BAC/max)*h); ctx.stroke();
  function dot(val, color) {
    ctx.fillStyle=color; const x=w*0.95; const y=h-(val/max)*h; ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill();
  }
  dot(AC,'#dc2626'); dot(EV,'#ff6600');
  ctx.restore();
}

// Mettre √† jour le tableau de bord en fonction des donn√©es du chantier s√©lectionn√© et des champs saisis
function updateTableau() {
  const cid = localStorage.getItem('currentChantier');
  const chantier = loadChantiers().find(c => c.id === cid);
  if(!chantier) {
    // R√©initialiser
    const fields = ['bMO','dMO','rMO','pMO','bST','dST','rST','pST','bF','dF','rF','pF','bL','dL','rL','pL','bTOT','dTOT','rTOT','pTOT','EAC','kDevis','kEAC','kMarge','kMargePct','kCPI','kSPI'];
    fields.forEach(id => { const el=document.getElementById(id); if(el) el.textContent='‚Äî'; });
    return;
  }
  const bMO = chantier.budgets.bMO;
  const bST = chantier.budgets.bST;
  const bF = chantier.budgets.bF;
  const bL = chantier.budgets.bL;
  const BAC = bMO + bST + bF + bL;
  // Inputs
  const coutHoraire = parseFloat(document.getElementById('coutBase').value || 0) * (1 + (parseFloat(document.getElementById('chargesPct').value || 0) / 100));
  const depMO = parseFloat(document.getElementById('hReal').value || 0) * coutHoraire;
  const depST = parseFloat(document.getElementById('depST').value || 0);
  const depF = parseFloat(document.getElementById('depF').value || 0);
  const depL = parseFloat(document.getElementById('depL').value || 0);
  const AC = depMO + depST + depF + depL;
  const g = clamp(parseFloat(document.getElementById('avcGlobal').value),0,100)/100;
  const avMO = document.getElementById('avcMO').value !== '' ? clamp(parseFloat(document.getElementById('avcMO').value),0,100)/100 : null;
  const avST = document.getElementById('avcST').value !== '' ? clamp(parseFloat(document.getElementById('avcST').value),0,100)/100 : null;
  const avF  = document.getElementById('avcF').value  !== '' ? clamp(parseFloat(document.getElementById('avcF').value),0,100)/100  : null;
  const avL  = document.getElementById('avcL').value  !== '' ? clamp(parseFloat(document.getElementById('avcL').value),0,100)/100  : null;
  const hasCat = [avMO,avST,avF,avL].every(v => v !== null);
  const EV = hasCat ? (bMO*avMO + bST*avST + bF*avF + bL*avL) : (BAC * g);
  const CPI = AC > 0 ? EV/AC : 1;
  const method = document.getElementById('method').value;
  let ETC=0, methodLabel='';
  if(method === 'cpi') {
    const cpi = clamp(CPI,0.5,2.0);
    ETC = Math.max(0, (BAC - EV) / cpi);
    methodLabel = 'CPI (valeur acquise)';
  } else {
    ETC = Math.max(0, BAC - AC);
    methodLabel = 'Na√Øve (budget restant)';
  }
  const EAC_no = AC + ETC;
  const imprevus = EAC_no * (clamp(parseFloat(document.getElementById('imprevusPct').value),0,100) / 100);
  const EAC = EAC_no + imprevus;
  const resteMO=bMO-depMO, resteST=bST-depST, resteF=bF-depF, resteL=bL-depL;
  const pMO=(bMO>0?depMO/bMO:0)*100, pST=(bST>0?depST/bST:0)*100, pF=(bF>0?depF/bF:0)*100, pL=(bL>0?depL/bL:0)*100, pTOT=(BAC>0?AC/BAC:0)*100;
  // Tableau
  document.getElementById('bMO').textContent = FR.format(bMO);
  document.getElementById('dMO').textContent = FR.format(depMO);
  document.getElementById('rMO').textContent = FR.format(resteMO);
  document.getElementById('pMO').textContent = PCT(pMO);
  document.getElementById('bST').textContent = FR.format(bST);
  document.getElementById('dST').textContent = FR.format(depST);
  document.getElementById('rST').textContent = FR.format(resteST);
  document.getElementById('pST').textContent = PCT(pST);
  document.getElementById('bF').textContent  = FR.format(bF);
  document.getElementById('dF').textContent  = FR.format(depF);
  document.getElementById('rF').textContent  = FR.format(resteF);
  document.getElementById('pF').textContent  = PCT(pF);
  document.getElementById('bL').textContent  = FR.format(bL);
  document.getElementById('dL').textContent  = FR.format(depL);
  document.getElementById('rL').textContent  = FR.format(resteL);
  document.getElementById('pL').textContent  = PCT(pL);
  document.getElementById('bTOT').textContent = FR.format(BAC);
  document.getElementById('dTOT').textContent = FR.format(AC);
  document.getElementById('rTOT').textContent = FR.format(resteMO + resteST + resteF + resteL);
  document.getElementById('pTOT').textContent = PCT(pTOT);
  document.getElementById('EAC').textContent = FR.format(EAC);
  // Barres
  function setBar(idBar, idTxt, p) {
    document.getElementById(idBar).style.width = PCT(p);
    document.getElementById(idTxt).textContent = PCT(p);
  }
  setBar('barMO','txtPMO',pMO);
  setBar('barF','txtPF',pF);
  setBar('barTOT','txtPT',pTOT);
  const donut = document.getElementById('donut'); const donutTxt = document.getElementById('donutTxt');
  donut.setAttribute('stroke-dasharray', `${clamp(pTOT,0,100)} ${100 - clamp(pTOT,0,100)}`);
  donutTxt.textContent = PCT(pTOT);
  // Alertes
  const alerts = [];
  const threshold = parseFloat(document.getElementById('alertThreshold').value);
  if(pTOT > threshold) alerts.push({ c:'cr', t:`Budget critique¬†: > ${threshold}% utilis√©` });
  else if(pTOT > threshold - 10) alerts.push({ c:'warn', t:`Attention¬†: > ${threshold - 10}% du budget consomm√©` });
  else if(pTOT < 50) alerts.push({ c:'ok', t:'Budget ma√Ætris√©¬†: < 50% utilis√©' });
  if((chantier.devis - EAC) < 0) alerts.push({ c:'cr', t:'Marge n√©gative projet√©e' });
  document.getElementById('alerts').innerHTML = alerts.map(a => `<div class="alert ${a.c}">‚ö†Ô∏è ${a.t}</div>`).join('');
  // KPI
  document.getElementById('kDevis').textContent = FR.format(chantier.devis);
  document.getElementById('kEAC').textContent = FR.format(EAC);
  document.getElementById('kMethod').textContent = methodLabel;
  const marge = chantier.devis - EAC;
  const mPct = (chantier.devis>0 ? (marge / chantier.devis) * 100 : 0);
  const kM = document.getElementById('kMarge');
  kM.textContent = FR.format(marge); kM.className = 'v ' + (marge >= 0 ? 'pos' : 'neg');
  const kMP = document.getElementById('kMargePct');
  kMP.textContent = PCT(mPct); kMP.className = 'v ' + (mPct >= 0 ? 'pos' : 'neg');
  document.getElementById('kCPI').textContent = CPI.toFixed(2);
  // Calcul du SPI : EV / (PV) o√π PV = BAC * avancement moyen ou g
  const avgProgress = hasCat ? ((avMO + avST + avF + avL) / 4) : g;
  const SPI = (BAC > 0 && avgProgress > 0) ? (EV / (BAC * avgProgress)) : 1;
  document.getElementById('kSPI').textContent = SPI.toFixed(2);
  // Notes
  const notes = [];
  if(pMO>85) notes.push('üë∑ Surconsommation MO¬†: ajuster staffing/productivit√©.');
  if(pF>85) notes.push('üì¶ Fournitures proches du plafond¬†: alternatives / groupements d\'achat.');
  if(CPI<0.9) notes.push('üìâ CPI < 0.9¬†: d√©rive de co√ªt √† corriger.');
  if(marge < chantier.devis * 0.05) notes.push('üí° Marge faible¬†: ren√©gociation ou r√©duction des co√ªts restants.');
  document.getElementById('notes').innerHTML = notes.length ? notes.map(n => `‚Ä¢ ${n}`).join('<br>') : '‚úÖ Situation sous contr√¥le.';
  // Graphiques
  drawBars(document.getElementById('chartBars'), ['MO','ST','Fourn.','Loc.'], [bMO,bST,bF,bL], [depMO,depST,depF,depL]);
  drawBurn(document.getElementById('chartBurn'), AC, EV, BAC);
}
// Rendu de la page tableau (injection HTML et √©v√©nements)
function renderTableauPage() {
  // Alimenter le s√©lecteur de chantiers
  const sel = document.getElementById('tableauChantier');
  sel.innerHTML = '<option value="">‚Äî S√©lectionner ‚Äî</option>';
  loadChantiers().forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    sel.appendChild(opt);
  });
  const current = localStorage.getItem('currentChantier') || '';
  sel.value = current;
  sel.onchange = () => {
    localStorage.setItem('currentChantier', sel.value);
    renderInfosChantier();
    updateTableau();
  };
  // Injecter le gabarit si pas encore fait
  const container = document.getElementById('tableauContent');
  if(container.innerHTML.trim() === '') {
    container.innerHTML = tableauTemplate;
    // Attacher les √©v√©nements d'input pour mettre √† jour le tableau √† chaque modification
    ['coutBase','chargesPct','hReal','depST','depF','depL','imprevusPct','method','avcGlobal','avcMO','avcST','avcF','avcL','alertThreshold'].forEach(id => {
      const el = document.getElementById(id);
      if(el) {
        el.addEventListener('input', updateTableau);
        el.addEventListener('change', updateTableau);
      }
    });
  }
  renderInfosChantier();
  updateTableau();
}

/* ---------- Initialisation ---------- */
function init() {
  renderAccueil();
  renderReunionsPage();
  renderChantiersList();
  renderDocuments();
}
window.addEventListener('load', init);
</script>
</body>
</html>