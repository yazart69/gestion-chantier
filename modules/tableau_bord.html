
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de Bord Financier — V7.5 (EAC, CPI, KPI)</title>
  <link rel="stylesheet" href="../assets/css/shared.css">
  <link rel="stylesheet" href="../assets/css/print.css" media="print">
  <style>
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    .btn-row{display:flex;gap:12px;flex-wrap:wrap}
    .projet-info{background:linear-gradient(135deg,#fff,#fafafa);border:1px solid var(--border);border-radius:1rem;padding:16px 18px;box-shadow:0 8px 20px rgba(0,0,0,.08);margin-bottom:16px;position:relative}
    .projet-info::before{content:"";position:absolute;inset:0 0 auto 0;height:4px;border-radius:1rem 1rem 0 0;background:linear-gradient(90deg,var(--primary-red),var(--primary-orange))}
    .tabs{display:flex;gap:8px;margin:8px 0 16px}
    .tab{padding:.6rem 1rem;border:2px solid var(--border);border-radius:.75rem;background:#fff;cursor:pointer;font-weight:700}
    .tab.active{border-color:var(--primary-red);color:var(--primary-red);box-shadow:0 0 0 3px rgba(220,38,38,.12)}
    .mini{font-size:.78rem;color:#6b7280}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;font-size:.85rem}
    .dot{width:.8rem;height:.8rem;border-radius:50%;display:inline-block}
    canvas{width:100%;height:300px}
    .donut{width:180px;height:180px;display:block;margin:0 auto}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>💰 Tableau de Bord Financier — V7.5</h1>
      <div class="btn-row">
        <button class="btn btn-neutral" id="btnPrint">🖨️ Imprimer</button>
        <button class="btn btn-gradient" id="btnPDF">Exporter PDF</button>
        <button class="btn btn-primary" id="btnSave">💾 Enregistrer</button>
        <label class="btn btn-dark" for="fileLoad">📂 Charger<input id="fileLoad" type="file" accept="application/json" style="display:none"></label>
      </div>
    </header>

    <div id="helpMount"></div>

    <div class="projet-info">
      <div style="display:flex;flex-wrap:wrap;align-items:center;gap:12px;justify-content:space-between">
        <div><strong>Équipe 41 – Altrad Prezioso</strong> • Suivi EAC (CPI) • KPI temps réel</div>
        <div class="tabs">
          <button class="tab active" data-tab="projet">Projet</button>
          <button class="tab" data-tab="kpi">KPI & Graphiques</button>
        </div>
      </div>
    </div>

    <section id="tab-projet" class="grid">
      <div class="card">
        <h2><span class="i">⚙️</span>Paramètres & Saisie</h2>
        <div class="form-grid">
          <div class="f col-6"><label>Chantier</label><select id="chantier"></select></div>
          <div class="f col-3"><label>Coût horaire base (€/h)</label><input id="coutBase" type="number" step="0.1" value="22"><div class="mini">Salaire + primes</div></div>
          <div class="f col-3"><label>Charges & frais (%)</label><input id="chargesPct" type="number" min="0" max="200" step="1" value="85"><div class="mini">Patronales + structure</div></div>
          <div class="f col-3"><label>Heures MO réalisées (h)</label><input id="hReal" type="number" step="0.1" value="168"></div>
          <div class="f col-3"><label>Dépenses ST (€)</label><input id="depST" type="number" step="0.01" value="5000"></div>
          <div class="f col-3"><label>Dépenses Fournitures (€)</label><input id="depF" type="number" step="0.01" value="12500"></div>
          <div class="f col-3"><label>Dépenses Locations (€)</label><input id="depL" type="number" step="0.01" value="2500"></div>
          <div class="f col-3"><label>Imprévus (%)</label><input id="imprevusPct" type="number" step="0.5" min="0" max="30" value="7"></div>
          <div class="f col-3"><label>Méthode de prévision</label>
            <select id="method"><option value="cpi" selected>CPI (valeur acquise)</option><option value="naive">Naïve (budget restant)</option></select>
          </div>
          <div class="col-12"></div>
          <div class="f col-3"><label>Avancement global (%)</label><input id="avcGlobal" type="number" min="0" max="100" value="45"><div class="mini">Utilisé si les % par catégorie sont vides</div></div>
          <div class="f col-3"><label>Avancement MO (%)</label><input id="avcMO" type="number" min="0" max="100" placeholder=""></div>
          <div class="f col-3"><label>Avancement ST (%)</label><input id="avcST" type="number" min="0" max="100" placeholder=""></div>
          <div class="f col-3"><label>Avancement Fourn. (%)</label><input id="avcF" type="number" min="0" max="100" placeholder=""></div>
          <div class="f col-3"><label>Avancement Loc. (%)</label><input id="avcL" type="number" min="0" max="100" placeholder=""></div>
        </div>
      </div>

      <div class="card">
        <h2><span class="i">🔔</span>Alertes</h2>
        <div id="alerts"></div>
        <div id="notes" class="mini"></div>
      </div>

      <div class="card" style="grid-column:1 / -1">
        <h2><span class="i">📋</span>Résumé financier</h2>
        <table class="table">
          <thead><tr><th>Catégorie</th><th class="num">Budgété (€)</th><th class="num">Dépensé (€)</th><th class="num">Reste (€)</th><th class="num">% Utilisé</th></tr></thead>
          <tbody>
            <tr><td>Main d'œuvre (interne)</td><td class="num" id="bMO">—</td><td class="num" id="dMO">—</td><td class="num" id="rMO">—</td><td class="num" id="pMO">—</td></tr>
            <tr><td>Sous-traitance</td><td class="num" id="bST">—</td><td class="num" id="dST">—</td><td class="num" id="rST">—</td><td class="num" id="pST">—</td></tr>
            <tr><td>Fournitures & matériel</td><td class="num" id="bF">—</td><td class="num" id="dF">—</td><td class="num" id="rF">—</td><td class="num" id="pF">—</td></tr>
            <tr><td>Locations</td><td class="num" id="bL">—</td><td class="num" id="dL">—</td><td class="num" id="rL">—</td><td class="num" id="pL">—</td></tr>
            <tr class="total"><td>TOTAL Coûts directs (BAC)</td><td class="num" id="bTOT">—</td><td class="num" id="dTOT">—</td><td class="num" id="rTOT">—</td><td class="num" id="pTOT">—</td></tr>
          </tbody>
          <tfoot><tr class="grand"><td colspan="4">EAC – Coût à terminaison (avec imprévus)</td><td class="num" id="EAC">—</td></tr></tfoot>
        </table>

        <div class="grid" style="grid-template-columns:1fr 1fr 1fr 1fr;margin-top:12px;gap:12px">
          <div class="card" style="padding:12px">
            <div class="row" style="display:flex;justify-content:space-between"><strong>Main d'œuvre</strong><span id="txtPMO">0%</span></div>
            <div class="progress"><div class="bar" id="barMO"></div></div>
          </div>
          <div class="card" style="padding:12px">
            <div class="row" style="display:flex;justify-content:space-between"><strong>Fournitures</strong><span id="txtPF">0%</span></div>
            <div class="progress"><div class="bar" id="barF"></div></div>
          </div>
          <div class="card" style="padding:12px">
            <div class="row" style="display:flex;justify-content:space-between"><strong>Budget global</strong><span id="txtPT">0%</span></div>
            <div class="progress"><div class="bar" id="barTOT"></div></div>
          </div>
          <div class="card" style="padding:12px;text-align:center">
            <svg class="donut" viewBox="0 0 42 42">
              <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#e5e7eb" stroke-width="6"></circle>
              <circle id="donut" cx="21" cy="21" r="15.915" fill="transparent" stroke="url(#g)" stroke-width="6" stroke-linecap="round" stroke-dasharray="0 100" transform="rotate(-90 21 21)"></circle>
              <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="0"><stop offset="0" stop-color="#dc2626"/><stop offset="1" stop-color="#ff6600"/></linearGradient></defs>
              <text id="donutTxt" x="50%" y="50%" text-anchor="middle" dominant-baseline="central" style="font-weight:800;font-size:18px;fill:#111827">0%</text>
            </svg>
            <div class="mini">Budget utilisé (AC/BAC)</div>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-kpi" style="display:none">
      <div class="card">
        <h2><span class="i">📊</span>KPI</h2>
        <div class="kpis">
          <div class="k"><h3>Prix de vente</h3><div class="v neu" id="kDevis">—</div><div class="mini">Montant contractuel</div></div>
          <div class="k"><h3>EAC (coût projeté)</h3><div class="v neu" id="kEAC">—</div><div class="mini" id="kMethod">Méthode</div></div>
          <div class="k"><h3>Marge prévisionnelle</h3><div class="v" id="kMarge">—</div><div class="mini" id="kTrend">Performance</div></div>
          <div class="k"><h3>Taux de marge</h3><div class="v" id="kMargePct">—</div><div class="mini">Rentabilité</div></div>
          <div class="k"><h3>CPI</h3><div class="v neu" id="kCPI">—</div><div class="mini">EV / AC</div></div>
          <div class="k"><h3>SPI (proxy)</h3><div class="v neu" id="kSPI">—</div><div class="mini">EV / PV</div></div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h2><span class="i">📶</span>Budgété vs Dépensé</h2>
          <canvas id="chartBars" width="800" height="300" aria-label="Budgété vs Dépensé"></canvas>
          <div class="legend"><span><span class="dot" style="background:#9ca3af"></span>Budgété</span><span><span class="dot" style="background:#dc2626"></span>Dépensé</span></div>
        </div>
        <div class="card">
          <h2><span class="i">📈</span>Burn-up (EV, AC, BAC)</h2>
          <canvas id="chartBurn" width="800" height="300" aria-label="Burn-up EV/AC/BAC"></canvas>
          <div class="legend"><span><span class="dot" style="background:#dc2626"></span>AC</span><span><span class="dot" style="background:#ff6600"></span>EV</span><span><span class="dot" style="background:#9ca3af"></span>BAC</span></div>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import { APP_VERSION, saveState, loadState, fmtEUR, pct } from '../assets/js/app.js';
    import { mountHelp } from '../assets/js/help.js';

    mountHelp(document.getElementById('helpMount'));

    const el = id => document.getElementById(id);
    const chantiersDB=[
      {id:1,name:'Rénovation Usine Lyon', devis:55000, bMO:24000,bF:12000,bL:3000,bST:0, spi:0.92},
      {id:2,name:'Chantier Naval - La Ciotat', devis:210000, bMO:90000,bF:40000,bL:15000,bST:25000, spi:0.95},
      {id:3,name:'Grand Lyon - Pont de Chasse', devis:125000, bMO:45000,bF:28000,bL:8000,bST:15000, spi:1.02},
    ];
    const P = (v)=>Math.min(100,Math.max(0,Math.round(v||0)));

    function fillSelect(){
      const sel=el('chantier');
      sel.innerHTML='<option value="">— Sélectionner —</option>';
      chantiersDB.forEach(c=> sel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
      const saved = loadState('lastChantierId', chantiersDB[0].id);
      sel.value = saved;
    }

    function num(v){ const n=parseFloat(v); return isNaN(n)?0:n; }

    function drawBars(canvas, labels, budget, depense){
      const ctx=canvas.getContext('2d'); const W=canvas.width, H=canvas.height;
      ctx.clearRect(0,0,W,H); ctx.save(); ctx.translate(50,20);
      const w=W-70, h=H-50; const max=Math.max(1,...budget,...depense);
      ctx.strokeStyle='#e5e7eb'; for(let i=0;i<=4;i++){ const y=h-(i/4)*h; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); ctx.fillStyle='#6b7280'; ctx.font='12px system-ui'; ctx.fillText(fmtEUR((i/4)*max), w+8,y+4); }
      const n=labels.length, group=w/n, bw=Math.min(26,(group-18)/2);
      for(let i=0;i<n;i++){ const x=i*group+18; const hb=(budget[i]/max)*h; ctx.fillStyle='#9ca3af'; ctx.fillRect(x, h-hb, bw, hb); const hd=(depense[i]/max)*h; ctx.fillStyle='#dc2626'; ctx.fillRect(x+bw+8, h-hd, bw, hd); ctx.fillStyle='#374151'; ctx.fillText(labels[i], x-4, h+16); }
      ctx.restore();
    }

    function drawBurn(canvas, AC, EV, BAC){
      const ctx=canvas.getContext('2d'); const W=canvas.width, H=canvas.height;
      ctx.clearRect(0,0,W,H); ctx.save(); ctx.translate(40,20);
      const w=W-60, h=H-50; const max=Math.max(BAC, AC*1.1, EV*1.1, 1);
      ctx.strokeStyle='#e5e7eb'; for(let i=0;i<=4;i++){ const y=h-(i/4)*h; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); ctx.fillStyle='#6b7280'; ctx.font='12px system-ui'; ctx.fillText(fmtEUR((i/4)*max), w+8,y+4); }
      ctx.strokeStyle='#9ca3af'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(0, h-(BAC/max)*h); ctx.lineTo(w, h-(BAC/max)*h); ctx.stroke();
      function dot(val, color){ ctx.fillStyle=color; const x=w*0.95; const y=h-(val/max)*h; ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill(); }
      dot(AC,'#dc2626'); dot(EV,'#ff6600'); ctx.restore();
    }

    function update(){
      const id = el('chantier').value;
      saveState('lastChantierId', id || chantiersDB[0].id);
      const c = chantiersDB.find(x=> x.id==id); if(!c){ return; }

      const bMO=c.bMO, bST=c.bST, bF=c.bF, bL=c.bL;
      const BAC=bMO+bST+bF+bL;

      const coutHoraire = num(el('coutBase').value) * (1+ num(el('chargesPct').value)/100);
      const depMO = num(el('hReal').value) * coutHoraire;
      const depST = num(el('depST').value);
      const depF = num(el('depF').value);
      const depL = num(el('depL').value);
      const AC = depMO+depST+depF+depL;

      const g = Math.min(1, Math.max(0, num(el('avcGlobal').value)/100));
      const avMO = el('avcMO').value!==''? Math.min(1,Math.max(0,num(el('avcMO').value)/100)) : null;
      const avST = el('avcST').value!==''? Math.min(1,Math.max(0,num(el('avcST').value)/100)) : null;
      const avF  = el('avcF').value!=='' ? Math.min(1,Math.max(0,num(el('avcF').value)/100))  : null;
      const avL  = el('avcL').value!=='' ? Math.min(1,Math.max(0,num(el('avcL').value)/100))  : null;
      const hasCat = [avMO,avST,avF,avL].every(v=> v!==null);
      const EV = hasCat ? (bMO*avMO + bST*avST + bF*avF + bL*avL) : (BAC*g);
      const CPI = AC>0 ? EV/AC : 1;
      const SPI = 1;

      const method = el('method').value;
      let ETC = 0, methodLabel='';
      if(method==='cpi'){ ETC = Math.max(0,(BAC - EV)/Math.min(2,Math.max(0.5,CPI))); methodLabel='CPI (valeur acquise)'; }
      else{ ETC = Math.max(0,BAC - AC); methodLabel='Naïve (budget restant)'; }
      const EAC_no = AC + ETC;
      const imprevus = EAC_no * (Math.min(1, Math.max(0, num(el('imprevusPct').value)/100)));
      const EAC = EAC_no + imprevus;

      const resteMO=bMO-depMO, resteST=bST-depST, resteF=bF-depF, resteL=bL-depL;
      const pMO=(bMO>0?depMO/bMO:0)*100, pST=(bST>0?depST/bST:0)*100, pF=(bF>0?depF/bF:0)*100, pL=(bL>0?depL/bL:0)*100, pTOT=(BAC>0?AC/BAC:0)*100;

      el('bMO').textContent=fmtEUR(bMO); el('dMO').textContent=fmtEUR(depMO); el('rMO').textContent=fmtEUR(resteMO); el('pMO').textContent=pct(pMO);
      el('bST').textContent=fmtEUR(bST); el('dST').textContent=fmtEUR(depST); el('rST').textContent=fmtEUR(resteST); el('pST').textContent=pct(pST);
      el('bF').textContent=fmtEUR(bF);   el('dF').textContent=fmtEUR(depF);   el('rF').textContent=fmtEUR(resteF);   el('pF').textContent=pct(pF);
      el('bL').textContent=fmtEUR(bL);   el('dL').textContent=fmtEUR(depL);   el('rL').textContent=fmtEUR(resteL);   el('pL').textContent=pct(pL);
      el('bTOT').textContent=fmtEUR(BAC); el('dTOT').textContent=fmtEUR(AC); el('rTOT').textContent=fmtEUR(resteMO+resteST+resteF+resteL); el('pTOT').textContent=pct(pTOT);
      el('EAC').textContent=fmtEUR(EAC);

      const setBar=(id,txt,p)=>{ el(id).style.width=pct(P(p)); el(txt).textContent=pct(P(p)); };
      setBar('barMO','txtPMO',pMO); setBar('barF','txtPF',pF); setBar('barTOT','txtPT',pTOT);
      const donut=el('donut'), donutTxt=el('donutTxt'); const d=P(pTOT); donut.setAttribute('stroke-dasharray', `${d} ${100-d}`); donutTxt.textContent=pct(d);

      const alerts=el('alerts'); alerts.innerHTML='';
      const A=[]; if(pTOT>95) A.push({c:'cr',t:'Budget critique : > 95% utilisé'}); else if(pTOT>80) A.push({c:'wa',t:'Attention : > 80% du budget consommé'}); else if(pTOT<50) A.push({c:'ok',t:'Budget maîtrisé : < 50% utilisé'});
      if((c.devis - EAC)<0) A.push({c:'cr',t:'Marge négative projetée'});
      alerts.innerHTML = A.map(a=>`<div class="alert ${a.c}">⚠️ ${a.t}</div>`).join('');

      el('kDevis').textContent=fmtEUR(c.devis);
      el('kEAC').textContent=fmtEUR(EAC);
      el('kMethod').textContent=methodLabel;
      const marge=c.devis - EAC, mPct = (c.devis>0? (marge/c.devis)*100 : 0);
      const kM=el('kMarge'); kM.textContent=fmtEUR(marge); kM.className='v '+(marge>=0?'pos':'neg');
      const kMP=el('kMargePct'); kMP.textContent=pct(mPct); kMP.className='v '+(mPct>=0?'pos':'neg');
      el('kCPI').textContent=CPI.toFixed(2); el('kSPI').textContent=SPI.toFixed(2);
      const kTrend=el('kTrend'); kTrend.textContent = mPct>=15?'Excellente rentabilité': mPct>=8?'Bonne rentabilité': mPct>=0?'Rentabilité faible':'Projet déficitaire';

      drawBars(el('chartBars'), ['MO','ST','Fourn.','Loc.'], [bMO,bST,bF,bL], [depMO,depST,depF,depL]);
      drawBurn(el('chartBurn'), AC, EV, BAC);
    }

    function exportState(){
      const state={
        chantier: el('chantier').value, coutBase: el('coutBase').value, chargesPct: el('chargesPct').value, hReal: el('hReal').value,
        depST: el('depST').value, depF: el('depF').value, depL: el('depL').value, imprevusPct: el('imprevusPct').value, method: el('method').value,
        avcGlobal: el('avcGlobal').value, avcMO: el('avcMO').value, avcST: el('avcST').value, avcF: el('avcF').value, avcL: el('avcL').value
      };
      saveState('lastState', state);
      const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download='etat_tableau_v75.json'; a.click(); URL.revokeObjectURL(a.href);
    }
    function importState(file){
      const reader=new FileReader(); reader.onload=()=>{
        try{ const s=JSON.parse(reader.result); Object.entries(s).forEach(([k,v])=>{ if(el(k)) el(k).value=v; }); update(); }catch(e){ alert('Fichier invalide.'); }
      }; reader.readAsText(file);
    }
    function init(){
      fillSelect();
      const saved = loadState('lastState', null);
      if(saved){ Object.entries(saved).forEach(([k,v])=>{ if(el(k)) el(k).value=v; }); }
      ['chantier','coutBase','chargesPct','hReal','depST','depF','depL','imprevusPct','method','avcGlobal','avcMO','avcST','avcF','avcL']
        .forEach(id=>{ el(id).addEventListener('input', update); el(id).addEventListener('change', update); });
      document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
      document.getElementById('btnPDF').addEventListener('click', ()=>window.print());
      document.getElementById('btnSave').addEventListener('click', exportState);
      document.getElementById('fileLoad').addEventListener('change', e=>{ if(e.target.files[0]) importState(e.target.files[0]); });
      document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
        const name=t.dataset.tab; document.getElementById('tab-projet').style.display= name==='projet'?'grid':'none'; document.getElementById('tab-kpi').style.display= name==='kpi'?'block':'none';
      }));
      if(!el('chantier').value) el('chantier').value = chantiersDB[0].id;
      update();
    }
    init();
  </script>
</body>
</html>
