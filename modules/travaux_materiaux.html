<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Travaux & Mat√©riaux - Tugrul V0.8.1</title>
    

  <link rel="stylesheet" href="../assets/css/shared.css">
  <link rel="stylesheet" href="../assets/css/print.css" media="print">

</head>
<body>
  <div id="helpMount"></div>

    <div class="container">
        <nav class="back-nav">
            <a href="index.html" class="back-link">
                ‚Üê Retour √† l'accueil
            </a>
        </nav>

        <h1 class="page-title">Module Travaux & Mat√©riaux</h1>

        <div class="equipe-info">
            <h3>üèóÔ∏è √âquipe 41 - Chasse sur Rh√¥ne</h3>
            <p>Altrad Prezioso ‚Ä¢ Sp√©cialistes en peinture industrielle et protection anticorrosion</p>
        </div>
        
        <form id="main-form">

            <div class="card">
                <h2 class="form-title">1. Param√®tres du Projet</h2>
                <div class="form-grid-3">
                    <div>
                        <label>Syst√®me Corrosivit√© <span class="info-tooltip" data-tooltip="Selon ISO 12944-2">‚ÑπÔ∏è</span></label>
                        <select id="p_corrosivite" class="form-select">
                            <option value="C1">C1 - Tr√®s faible</option>
                            <option value="C2">C2 - Faible</option>
                            <option value="C3">C3 - Moyenne</option>
                            <option value="C4">C4 - √âlev√©e</option>
                            <option value="C5-I" selected>C5-I - Tr√®s √©lev√©e (Industriel)</option>
                            <option value="C5-M">C5-M - Tr√®s √©lev√©e (Marin)</option>
                            <option value="CX">CX - Extr√™me</option>
                        </select>
                        <span class="print-only" id="print_corrosivite"></span>
                    </div>
                    <div>
                        <label>Complexit√© Surface</label>
                        <select id="p_complexite" class="form-select">
                            <option value="Simple">Simple</option>
                            <option value="Moyenne" selected>Moyenne</option>
                            <option value="Complexe">Complexe</option>
                            <option value="Tr√®s complexe">Tr√®s complexe</option>
                        </select>
                        <span class="print-only" id="print_complexite"></span>
                    </div>
                    <div>
                        <label>Environnement</label>
                        <select id="p_environnement" class="form-select">
                            <option value="Standard" selected>Standard</option>
                            <option value="ATEX">Zone ATEX</option>
                            <option value="Alimentaire">Alimentaire</option>
                            <option value="Nucl√©aire">Nucl√©aire</option>
                            <option value="Pharmaceutique">Pharmaceutique</option>
                        </select>
                        <span class="print-only" id="print_environnement"></span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="form-title">2. Surfaces √† traiter</h2>
                <table class="dynamic-table" id="surfaces-table">
                    <thead>
                        <tr>
                            <th>Type de Surface</th>
                            <th>Surface (m¬≤)</th>
                            <th>√âtat initial</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="btn-add" id="add-surface-btn">‚ûï Ajouter une surface</button>
            </div>

            <div class="card">
                <h2 class="form-title">3. Pr√©paration de Surface</h2>
                <div class="highlight-section">
                    <p><strong>Pr√©parations standards :</strong></p>
                    <div class="checkbox-group" id="preparation-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="prep-sablage" value="Sablage Sa 2¬Ω">
                            <label for="prep-sablage">Sablage Sa 2¬Ω</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prep-hp" value="Nettoyage HP">
                            <label for="prep-hp">Nettoyage HP</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prep-grenaillage" value="Grenaillage">
                            <label for="prep-grenaillage">Grenaillage</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prep-protection" value="Protection surfaces">
                            <label for="prep-protection">Protection surfaces</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prep-mecanique" value="Pr√©paration m√©canique St3">
                            <label for="prep-mecanique">Pr√©paration m√©canique St3</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prep-degraissage" value="D√©graissage">
                            <label for="prep-degraissage">D√©graissage</label>
                        </div>
                    </div>
                </div>
                
                <h3 style="font-size: 1rem; margin-top: 1.5rem; margin-bottom: 1rem;">Pr√©parations sp√©ciales suppl√©mentaires</h3>
                <table class="dynamic-table" id="prep-manual-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Surface (m¬≤)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="btn-add" id="add-prep-manual-btn">‚ûï Ajouter une ligne</button>
            </div>

            <div class="card">
                <h2 class="form-title">4. Syst√®me de Peinture</h2>
                <div class="highlight-section">
                    <p><strong>Syst√®me certifi√© ACQPA recommand√©</strong> selon environnement s√©lectionn√©</p>
                </div>
                <table class="dynamic-table" id="coats-table">
                    <thead>
                        <tr>
                            <th style="width: 50%;">Produit / R√©f.</th>
                            <th>√âpaisseur (Œºm)</th>
                            <th>Rendement (m¬≤/L)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="btn-add" id="add-coat-btn">‚ûï Ajouter une couche</button>
            </div>

            <div class="card card-special">
                <h2 class="form-title form-title-special">5. Atelier M√©canique St Maurice - √âquipement & Environnement</h2>
                <div>
                    <label>Pr√©voir location de machines (Ctrl+Clic pour s√©lection multiple)</label>
                    <select id="machines-select" class="form-select" multiple style="height: 120px;">
                        <!-- Options seront ajout√©es via JavaScript -->
                    </select>
                </div>
                
                <h3 style="font-size: 1rem; margin-top: 1.5rem; margin-bottom: 1rem;">√âquipements sp√©ciaux suppl√©mentaires</h3>
                <table class="dynamic-table" id="machines-manual-table">
                    <thead>
                        <tr>
                            <th>√âquipement</th>
                            <th>Dur√©e (jours)</th>
                            <th>Co√ªt/jour (‚Ç¨)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="btn-add" id="add-machine-manual-btn">‚ûï Ajouter un √©quipement</button>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--info-border);">
                
                <div>
                    <label>Environnement sp√©cifique</label>
                    <div class="checkbox-group" id="env-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="env-amiante" value="Zone Amiante">
                            <label for="env-amiante">Zone Amiante</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="env-plomb" value="Zone Plomb">
                            <label for="env-plomb">Zone Plomb</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="env-atex" value="Zone ATEX">
                            <label for="env-atex">Zone ATEX</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="env-confinement" value="Confinement requis">
                            <label for="env-confinement">Confinement requis</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="env-ventilation" value="Ventilation forc√©e">
                            <label for="env-ventilation">Ventilation forc√©e</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="form-title">6. Estimation √âquipe & Dur√©e</h2>
                <div class="form-grid-3">
                    <div>
                        <label>Nombre d'op√©rateurs estim√© <span class="info-tooltip" data-tooltip="Bas√© sur la surface et complexit√©">‚ÑπÔ∏è</span></label>
                        <input type="number" id="nb-operateurs" class="form-input" min="1" value="2">
                        <span class="print-only" id="print_operateurs"></span>
                    </div>
                    <div>
                        <label>Nombre d'heures estim√©</label>
                        <input type="number" id="nb-heures" class="form-input" min="1" value="40">
                        <span class="print-only" id="print_heures"></span>
                    </div>
                    <div>
                        <label>Chef d'√©quipe assign√©</label>
                        <select id="chef-equipe" class="form-select">
                            <option value="">√Ä d√©finir</option>
                            <option value="a-mohamed">A MOHAMED</option>
                            <option value="antunez-loic">ANTUNEZ LOIC</option>
                            <option value="clemente-mickael">CLEMENTE MICKAEL</option>
                            <option value="cukur-mustafa">CUKUR MUSTAFA</option>
                            <option value="grandadam-g">GRANDADAM G</option>
                            <option value="ribeiro-casal-a">RIBEIRO-CASAL A</option>
                            <option value="moreau-jc">MOREAU JC</option>
                        </select>
                        <span class="print-only" id="print_chef"></span>
                    </div>
                </div>
            </div>
            
            <div class="summary-panel">
                 <h2 class="form-title" style="color: white; border-color: var(--primary-orange);">üìä R√©sum√© Technique</h2>
                 <div id="live-summary">
                     <p><em>Remplissez le formulaire pour voir le r√©sum√©...</em></p>
                 </div>
            </div>

             <div class="action-buttons">
                <button type="button" id="reset-btn" class="btn-action btn-reset">üîÑ Remettre √† z√©ro</button>
                <button type="button" id="print-btn" class="btn-action btn-print">üñ®Ô∏è Imprimer</button>
            </div>

        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const produitsPeinture = [
                'IKARSUN - Primaire √©poxy',
                'Epodux Primaire 61-134',
                'Polystria - Finition PU',
                'EPODUX BR100 - Barri√®re √©poxy',
                'POLYSTRIA Satin',
                'POLYSTRIA Mat',
                'EPODUX ST 86-31',
                'LATEXOR - Peinture latex',
                'HEMPADUR 15570 - √âpoxy haute r√©sistance',
                'HEMPATHANE 55210 - Polyur√©thane',
                'SIGMASHIELD - Protection marine',
                'INTERTHANE 990 - Finition',
                'JOTAMASTIC 90 - Primaire universel'
            ];

            const machines = [
                'Nacelle √©l√©vatrice 12m',
                'Nacelle √©l√©vatrice 20m',
                '√âchafaudage roulant',
                'Cuve √† fuel mobile',
                'Compresseur 7 bars',
                'Compresseur haute pression',
                'Nettoyeur HP 200 bars',
                'Nettoyeur HP 500 bars',
                'Station airless 45:1',
                'Station airless 60:1',
                'Marmite chauffante',
                'Pistolet airless',
                'Pistolet HVLP',
                'Aspirateur industriel THE',
                'Extracteur d\'air 1000 m¬≥/h',
                'Extracteur d\'air 2000 m¬≥/h',
                'Masque ventil√© 3M',
                'Combinaison jetable (lot 10)',
                'B√¢che de protection PE',
                'Scotch de masquage'
            ];

            const surfaceTypes = [
                'Acier au carbone',
                'Acier galvanis√©',
                'Acier inoxydable',
                'Aluminium',
                'B√©ton',
                'Bois',
                'Fonte',
                'M√©tallisation existante'
            ];

            const mainForm = document.getElementById('main-form');
            const summaryDiv = document.getElementById('live-summary');

            // Initialisation des selects
            function initializeSelects() {
                const machinesSelect = document.getElementById('machines-select');
                machines.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    option.textContent = m;
                    machinesSelect.appendChild(option);
                });
            }

            function updateSummary() {
                let summaryHTML = '<ul>';
                
                // Param√®tres projet
                const corrosivite = document.getElementById('p_corrosivite').value;
                const complexite = document.getElementById('p_complexite').value;
                const environnement = document.getElementById('p_environnement').value;
                
                if (corrosivite || complexite || environnement) {
                    summaryHTML += `<li><strong>Projet :</strong> ${corrosivite} ‚Ä¢ ${complexite} ‚Ä¢ ${environnement}</li>`;
                }

                // Surfaces
                const surfaceRows = mainForm.querySelectorAll('#surfaces-table tbody tr');
                let totalSurface = Array.from(surfaceRows).reduce((sum, row) => {
                    const surfaceInput = row.querySelector('input[placeholder="m¬≤"]');
                    return sum + (parseFloat(surfaceInput?.value) || 0);
                }, 0);
                
                if (totalSurface > 0) {
                    summaryHTML += `<li><strong>Surface totale :</strong> ${totalSurface.toFixed(2)} m¬≤</li>`;
                }

                // Pr√©paration
                let prepValues = Array.from(mainForm.querySelectorAll('#preparation-group input[type=checkbox]:checked')).map(cb => cb.value);
                const manualPreps = Array.from(mainForm.querySelectorAll('#prep-manual-table input')).map(input => input.value).filter(Boolean);
                prepValues.push(...manualPreps);
                if (prepValues.length > 0) {
                    summaryHTML += `<li><strong>Pr√©paration :</strong> ${prepValues.join(', ')}</li>`;
                }

                // Peinture
                let coatSummaries = Array.from(mainForm.querySelectorAll('#coats-table tbody tr')).map(row => {
                    const produitSelect = row.querySelector('select');
                    const epaisseurInput = row.querySelector('input[placeholder="Œºm"]');
                    const produit = produitSelect?.value;
                    const epaisseur = epaisseurInput?.value;
                    return produit ? `${produit} (${epaisseur || 'N/A'} Œºm)` : null;
                }).filter(Boolean);
                
                if (coatSummaries.length > 0) {
                    summaryHTML += `<li><strong>Application :</strong> ${coatSummaries.join(' / ')}</li>`;
                }
                
                // √âquipement
                let selectedMachines = Array.from(mainForm.querySelectorAll('#machines-select option:checked')).map(opt => opt.value);
                const manualMachines = Array.from(mainForm.querySelectorAll('#machines-manual-table tbody tr')).map(row => {
                    const equipInput = row.querySelector('input[placeholder="√âquipement"]');
                    return equipInput?.value;
                }).filter(Boolean);
                selectedMachines.push(...manualMachines);
                
                if (selectedMachines.length > 0) {
                    summaryHTML += `<li><strong>√âquipement :</strong> ${selectedMachines.join(', ')}</li>`;
                }

                // Environnement
                let envValues = Array.from(mainForm.querySelectorAll('#env-group input[type=checkbox]:checked')).map(cb => cb.value);
                if (envValues.length > 0) {
                    summaryHTML += `<li><strong>Environnement sp√©cial :</strong> ${envValues.join(', ')}</li>`;
                }

                // √âquipe
                const operateurs = mainForm.querySelector('#nb-operateurs').value;
                const heures = mainForm.querySelector('#nb-heures').value;
                const chef = mainForm.querySelector('#chef-equipe');
                const chefText = chef.options[chef.selectedIndex]?.text || '√Ä d√©finir';
                
                if (operateurs || heures) {
                    summaryHTML += `<li><strong>√âquipe :</strong> ${operateurs || 'N/A'} op√©rateurs, ${heures || 'N/A'} heures estim√©es</li>`;
                }
                
                if (chef.value) {
                    summaryHTML += `<li><strong>Chef d'√©quipe :</strong> ${chefText}</li>`;
                }

                // Mise √† jour des textes pour l'impression
                updatePrintValues();

                summaryHTML += '</ul>';
                summaryDiv.innerHTML = summaryHTML;
            }

            function updatePrintValues() {
                const pairs = [
                    ['p_corrosivite', 'print_corrosivite'],
                    ['p_complexite', 'print_complexite'],
                    ['p_environnement', 'print_environnement'],
                    ['nb-operateurs', 'print_operateurs'],
                    ['nb-heures', 'print_heures'],
                    ['chef-equipe', 'print_chef']
                ];

                pairs.forEach(([inputId, printId]) => {
                    const input = document.getElementById(inputId);
                    const printEl = document.getElementById(printId);
                    if (input && printEl) {
                        if (input.tagName === 'SELECT') {
                            printEl.textContent = input.options[input.selectedIndex]?.text || '';
                        } else {
                            printEl.textContent = input.value || '';
                        }
                    }
                });
            }
            
            function addRow(tbody, innerHTML, placeholder = '') {
                const row = tbody.insertRow();
                row.innerHTML = innerHTML.replace(/PLACEHOLDER_TEXT/g, placeholder);
                const removeBtn = row.querySelector('.btn-remove');
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => { 
                        row.remove(); 
                        updateSummary(); 
                    });
                }
                return row;
            }

            // Ajout des lignes initiales
            initializeSelects();
            
            // Surface initiale
            const surfaceOptions = surfaceTypes.map(type => `<option value="${type}">${type}</option>`).join('');
            addRow(
                mainForm.querySelector('#surfaces-table tbody'), 
                `<td><select class="form-select">${surfaceOptions}</select></td>
                 <td><input type="number" class="form-input" placeholder="m¬≤" min="0"></td>
                 <td><select class="form-select">
                     <option value="A">A - Neuf</option>
                     <option value="B">B - Bon √©tat</option>
                     <option value="C" selected>C - √âtat moyen</option>
                     <option value="D">D - Mauvais √©tat</option>
                 </select></td>
                 <td><button type="button" class="btn-remove">√ó</button></td>`
            );

            // Couche de peinture initiale
            const productOptions = produitsPeinture.map(p => `<option value="${p}">${p}</option>`).join('');
            addRow(
                mainForm.querySelector('#coats-table tbody'), 
                `<td><select class="form-select">${productOptions}</select></td>
                 <td><input type="number" class="form-input" placeholder="Œºm" min="1"></td>
                 <td><input type="number" class="form-input" placeholder="m¬≤/L" min="0.1" step="0.1"></td>
                 <td><button type="button" class="btn-remove">√ó</button></td>`
            );

            // √âcouteurs d'√©v√©nements
            mainForm.addEventListener('input', updateSummary);
            mainForm.addEventListener('change', updateSummary);
            
            document.getElementById('add-surface-btn').addEventListener('click', () => {
                addRow(
                    mainForm.querySelector('#surfaces-table tbody'), 
                    `<td><select class="form-select">${surfaceOptions}</select></td>
                     <td><input type="number" class="form-input" placeholder="m¬≤" min="0"></td>
                     <td><select class="form-select">
                         <option value="A">A - Neuf</option>
                         <option value="B">B - Bon √©tat</option>
                         <option value="C" selected>C - √âtat moyen</option>
                         <option value="D">D - Mauvais √©tat</option>
                     </select></td>
                     <td><button type="button" class="btn-remove">√ó</button></td>`
                );
                updateSummary();
            });

            document.getElementById('add-coat-btn').addEventListener('click', () => {
                addRow(
                    mainForm.querySelector('#coats-table tbody'), 
                    `<td><select class="form-select">${productOptions}</select></td>
                     <td><input type="number" class="form-input" placeholder="Œºm" min="1"></td>
                     <td><input type="number" class="form-input" placeholder="m¬≤/L" min="0.1" step="0.1"></td>
                     <td><button type="button" class="btn-remove">√ó</button></td>`
                );
                updateSummary();
            });

            document.getElementById('add-prep-manual-btn').addEventListener('click', () => {
                addRow(
                    mainForm.querySelector('#prep-manual-table tbody'), 
                    `<td><input type="text" class="form-input" placeholder="Description de la pr√©paration..."></td>
                     <td><input type="number" class="form-input" placeholder="m¬≤" min="0"></td>
                     <td><button type="button" class="btn-remove">√ó</button></td>`
                );
                updateSummary();
            });

            document.getElementById('add-machine-manual-btn').addEventListener('click', () => {
                addRow(
                    mainForm.querySelector('#machines-manual-table tbody'), 
                    `<td><input type="text" class="form-input" placeholder="√âquipement sp√©cial..."></td>
                     <td><input type="number" class="form-input" placeholder="Dur√©e" min="1"></td>
                     <td><input type="number" class="form-input" placeholder="‚Ç¨/jour" min="0" step="0.01"></td>
                     <td><button type="button" class="btn-remove">√ó</button></td>`
                );
                updateSummary();
            });
            
            document.getElementById('reset-btn').addEventListener('click', () => {
                if(confirm('√ätes-vous s√ªr de vouloir r√©initialiser le formulaire ?')) { 
                    location.reload(); 
                }
            });
            
            document.getElementById('print-btn').addEventListener('click', () => {
                updatePrintValues();
                window.print();
            });

            // Sauvegarde automatique
            setInterval(() => {
                const formData = new FormData(mainForm);
                const data = Object.fromEntries(formData.entries());
                localStorage.setItem('travaux_materiaux_v1', JSON.stringify(data));
            }, 30000); // Sauvegarde toutes les 30 secondes

            updateSummary();
        });
    </script>

  <script type="module">
    import { mountHelp } from '../assets/js/help.js';
    mountHelp(document.getElementById('helpMount') || document.body);
  </script>

</body>
</html>