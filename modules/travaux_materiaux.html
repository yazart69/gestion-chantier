<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Travaux & Matériaux - Tugrul V0.8.1</title>
    <link rel="stylesheet" href="../assets/css/shared.css">
    <link rel="stylesheet" href="../assets/css/print.css" media="print">
    <style>
        :root {
            --primary-red: #dc2626;
            --primary-orange: #ff6600;
            --success: #10b981;
            --error: #ef4444;
            --white: #ffffff;
            --info-bg: #eff6ff;
            --info-border: #93c5fd;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-700: #374151;
            --gray-900: #111827;
            --bg-primary: var(--gray-50);
            --bg-secondary: var(--white);
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-700);
            --border-primary: var(--gray-200);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        
        body { 
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
            background: var(--bg-primary); 
            color: var(--text-primary); 
        }
        
        .container { max-width: 900px; margin: 0 auto; padding: 2rem; }

        /* Navigation de retour */
        .back-nav {
            margin-bottom: 1.5rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-red);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            transition: all 150ms ease;
        }

        .back-link:hover {
            background: var(--gray-100);
        }
        
        .page-title { 
            text-align: center; 
            color: var(--primary-red); 
            margin-bottom: 2rem; 
            font-size: 2.25rem;
            font-weight: 700;
        }
        
        .card { 
            background: var(--bg-secondary); 
            border-radius: 0.75rem; 
            padding: 1.5rem; 
            box-shadow: var(--shadow-md); 
            margin-bottom: 1.5rem; 
        }
        
        .card-special { 
            background-color: var(--info-bg); 
            border: 1px solid var(--info-border); 
        }
        
        .form-title { 
            font-size: 1.25rem; 
            font-weight: 600; 
            color: var(--text-primary); 
            margin-bottom: 1.5rem; 
            padding-bottom: 0.75rem; 
            border-bottom: 2px solid var(--primary-red); 
            position: relative;
        }

        .form-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: var(--primary-orange);
        }
        
        .form-title-special { 
            color: var(--primary-orange); 
            border-color: var(--primary-orange); 
        }

        .form-title-special::after {
            background: var(--primary-red);
        }
        
        .form-label { 
            display: block; 
            font-weight: 500; 
            margin-bottom: 0.5rem; 
            font-size: 0.875rem; 
        }
        
        .form-input, .form-select { 
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid var(--border-primary); 
            border-radius: 0.5rem; 
            font-size: 1rem; 
            transition: border-color 150ms ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        
        .form-grid-3 { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 1rem; 
        }
        
        .checkbox-group { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 1.5rem; 
        }
        
        .checkbox-item { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-red);
        }
        
        .dynamic-table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        
        .dynamic-table th, .dynamic-table td { 
            padding: 0.75rem; 
            text-align: left; 
            border-bottom: 1px solid var(--border-primary); 
        }
        
        .dynamic-table th { 
            font-size: 0.8rem; 
            white-space: nowrap; 
            background: var(--gray-100);
            font-weight: 600;
        }
        
        .dynamic-table input { 
            font-size: 0.9rem; 
            padding: 0.5rem; 
        }
        
        .btn-add { 
            background: var(--success); 
            color: white; 
            border: none; 
            padding: 0.5rem 1rem; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            margin-top: 1rem; 
            font-weight: 500;
            transition: background-color 150ms ease;
        }

        .btn-add:hover {
            background: #059669;
        }
        
        .btn-remove { 
            background: var(--error); 
            color: white; 
            border: none; 
            padding: 0.2rem 0.5rem; 
            border-radius: 50%; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 0.8rem;
        }

        .btn-remove:hover {
            background: #dc2626;
        }
        
        .summary-panel { 
            background: #002b49; 
            color: white; 
            border-radius: 0.75rem; 
            padding: 1.5rem; 
            box-shadow: var(--shadow-md); 
        }
        
        .summary-panel ul { 
            list-style: none; 
            padding: 0; 
        }
        
        .summary-panel li { 
            margin-bottom: 0.75rem; 
            padding-bottom: 0.75rem; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
        }
        
        .summary-panel li:last-child { 
            border-bottom: none; 
            margin-bottom: 0; 
        }
        
        .summary-panel strong { 
            color: var(--primary-orange); 
        }
        
        .action-buttons { 
            display: flex; 
            gap: 1rem; 
            margin-top: 2rem; 
        }
        
        .btn-action { 
            width: 100%; 
            padding: 0.75rem; 
            font-size: 1rem; 
            font-weight: bold; 
            border-radius: 0.5rem; 
            border: none; 
            cursor: pointer; 
            transition: all 150ms ease;
        }
        
        .btn-print { 
            background-color: var(--primary-red); 
            color: white; 
        }

        .btn-print:hover {
            background-color: #b91c1c;
            transform: translateY(-1px);
        }
        
        .btn-reset { 
            background-color: var(--gray-200); 
            color: var(--gray-700); 
        }

        .btn-reset:hover {
            background-color: var(--gray-300);
        }

        .print-only { display: none; }

        /* Équipe 41 branding */
        .equipe-info {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.05), rgba(255, 102, 0, 0.05));
            border: 1px solid rgba(220, 38, 38, 0.2);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .equipe-info h3 {
            color: var(--primary-red);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .equipe-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Améliorations visuelles */
        .highlight-section {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.03), rgba(255, 102, 0, 0.03));
            border-left: 4px solid var(--primary-red);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 0.5rem 0.5rem 0;
        }

        .info-tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: var(--primary-red);
            margin-left: 0.25rem;
        }

        .info-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-900);
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 150ms ease;
            z-index: 1000;
        }

        .info-tooltip:hover::after {
            opacity: 1;
        }

        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body { 
                background: white !important; 
                color: black !important; 
                font-size: 10pt; 
                line-height: 1.4; 
                margin: 0;
                padding: 15mm;
            }
            
            .container { 
                max-width: 100%; 
                padding: 0; 
                margin: 0; 
            }

            .back-nav {
                display: none !important;
            }
            
            .page-title { 
                font-size: 16pt;
                margin-bottom: 12pt;
                text-align: center;
                border-bottom: 2pt solid var(--primary-red);
                padding-bottom: 6pt;
            }

            .equipe-info {
                border: 1pt solid #ccc;
                background: #f9f9f9 !important;
                margin-bottom: 10pt;
                padding: 8pt;
                break-inside: avoid;
            }

            .equipe-info h3 {
                font-size: 10pt;
                margin-bottom: 3pt;
            }

            .equipe-info p {
                font-size: 8pt;
            }
            
            .card, .summary-panel { 
                box-shadow: none; 
                border: 1pt solid #ccc; 
                margin-bottom: 8pt; 
                break-inside: avoid; 
                page-break-inside: avoid;
            }

            .card-special {
                background: #f9f9f9 !important;
                border: 1pt solid #999 !important;
            }
            
            .form-title {
                font-size: 12pt;
                margin-bottom: 8pt;
                padding-bottom: 4pt;
                border-bottom: 1pt solid var(--primary-red);
                break-after: avoid;
                page-break-after: avoid;
            }

            .form-title::after {
                display: none;
            }
            
            .form-input, .form-select { 
                display: none !important; 
            }
            
            .print-only { 
                display: inline !important; 
                font-weight: bold; 
                border-bottom: 1pt dotted #999;
                padding-bottom: 1pt;
            }
            
            .checkbox-group label { 
                text-decoration: line-through; 
                color: #999; 
                font-size: 9pt;
            }
            
            .checkbox-group input:checked + label { 
                text-decoration: none; 
                color: black; 
                font-weight: bold;
            }
            
            .summary-panel { 
                color: black !important; 
                background: var(--gray-50) !important; 
            }
            
            .summary-panel strong { 
                color: black !important; 
            }

            .dynamic-table {
                font-size: 8pt;
                margin-bottom: 8pt;
            }

            .dynamic-table th {
                background: #f0f0f0 !important;
                font-size: 8pt;
                padding: 4pt;
            }

            .dynamic-table td {
                padding: 4pt;
                border-bottom: 1pt solid #ddd;
            }

            .dynamic-table input {
                border: none !important;
                background: none !important;
                font-size: 8pt;
                padding: 0;
            }

            .btn-add, .btn-remove, .action-buttons {
                display: none !important;
            }

            .checkbox-item {
                margin-bottom: 2pt;
                font-size: 9pt;
            }

            .form-grid-3 {
                grid-template-columns: repeat(3, 1fr);
                gap: 6pt;
            }

            .highlight-section {
                border-left: 2pt solid var(--primary-red);
                padding: 6pt;
                margin: 6pt 0;
                background: #f9f9f9 !important;
            }

            .info-tooltip::after {
                display: none !important;
            }

            /* Éviter les coupures */
            .card,
            .summary-panel,
            .equipe-info,
            .highlight-section {
                break-inside: avoid;
                page-break-inside: avoid;
            }

            .form-title,
            h2, h3, h4 {
                break-after: avoid;
                page-break-after: avoid;
            }

            .dynamic-table {
                break-inside: avoid;
            }

            tr {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="back-nav">
            <!-- Lien retour : depuis un module vers l'accueil -->
            <a href="../index.html" class="back-link">
                ← Retour à l'accueil
            </a>
        </nav>

        <h1 class="page-title">Module Travaux & Matériaux</h1>

        <div class="equipe-info">
            <h3>🏗️ Équipe 41 - Chasse sur Rhône</h3>
            <p>Altrad Prezioso • Spécialistes en peinture industrielle et protection anticorrosion</p>
        </div>
        
        <form id="main-form">

            <div class="card">
                <h2 class="form-title">1. Paramètres du Projet</h2>
                <div class="form-grid-3">
                    <div>
                        <label>Système Corrosivité <span class="info-tooltip" data-tooltip="Selon ISO 12944-2">ℹ️</span></label>
                        <select id="p_corrosivite" class="form-select">
                            <option value="C1">C1 - Très faible</option>
                            <option value="C2">C2 - Faible</option>
                            <option value="C3">C3 - Moyenne</option>
                            <option value="C4">C4 - Élevée</option>
                            <option value="C5-I" selected>C5-I - Très élevée (Industriel)</option>
                            <option value="C5-M">C5-M - Très élevée (Marin)</option>
                            <option value="CX">CX - Extrême</option>
                        </select>
                        <span class="print-only" id="print_corrosivite"></span>
                    </div>
                    <div>
                        <label>Complexité Surface</label>
                        <select id="p_complexite" class="form-select">
                            <option value="Simple">Simple</option>
                            <option value="Moyenne" selected>Moyenne</option>
                            <option value="Complexe">Complexe</option>
                            <option value="Très complexe">Très complexe</option>
                        </select>
                        <span class="print-only" id="print_complexite"></span>
                    </div>
                    <div>
                        <label>Environnement</label>
                        <select id="p_environnement" class="form-select">
                            <option value="Standard" selected>Standard</option>
                            <option value="ATEX">Zone ATEX</option>
                            <option value="Alimentaire">Alimentaire</option>
                            <option value="Nucléaire">Nucléaire</option>
                            <option value="Pharmaceutique">Pharmaceutique</option>
                        </select>
                        <span class="print-only" id="print_environnement"></span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="form-title">2. Surfaces à traiter</h2>
                <table class="dynamic-table" id="surfaces-table">
                    <thead>
                        <tr>
                            <th>Type de Surface</th>
                            <th>Surface (m²)</th>
                            <th>État initial</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="btn-add" id="add-surface-btn">➕ Ajouter une surface</button>
            </div>

            <div class="card">
                <h2 class="form-title">3. Préparation de Surface</h2>
                <div class="highlight-section">
                    <p><strong>Préparations standards :</strong></p>
                    <div class="checkbox-group" id="preparation-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="prep-sablage" value="Sablage Sa 2½">
                            <label for="prep-sablage">Sablage Sa 2½</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prep-hp" value="Nettoyage HP">
                            <label for="prep-hp">Nettoyage HP</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prep-grenaillage" value="Grenaillage">
                            <label for="prep-grenaillage">Grenaillage</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prep-protection" value="Protection surfaces">
                            <label for="prep-protection">Protection surfaces</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prep-mecanique" value="Préparation mécanique St3">
                            <label for="prep-mecanique">Préparation mécanique St3</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prep-degraissage" value="Dégraissage">
                            <label for="prep-degraissage">Dégraissage</label>
                        </div>
                    </div>
                </div>
                
                <h3 style="font-size: 1rem; margin-top: 1.5rem; margin-bottom: 1rem;">Préparations spéciales supplémentaires</h3>
                <table class="dynamic-table" id="prep-manual-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Surface (m²)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="btn-add" id="add-prep-manual-btn">➕ Ajouter une ligne</button>
            </div>

            <div class="card">
                <h2 class="form-title">4. Système de Peinture</h2>
                <div class="highlight-section">
                    <p><strong>Système certifié ACQPA recommandé</strong> selon environnement sélectionné</p>
                </div>
                <table class="dynamic-table" id="coats-table">
                    <thead>
                        <tr>
                            <th style="width: 50%;">Produit / Réf.</th>
                            <th>Épaisseur (μm)</th>
                            <th>Rendement (m²/L)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="btn-add" id="add-coat-btn">➕ Ajouter une couche</button>
            </div>

            <div class="card card-special">
                <h2 class="form-title form-title-special">5. Atelier Mécanique St Maurice - Équipement & Environnement</h2>
                <div>
                    <label>Prévoir location de machines (Ctrl+Clic pour sélection multiple)</label>
                    <select id="machines-select" class="form-select" multiple style="height: 120px;">
                        <!-- Options seront ajoutées via JavaScript -->
                    </select>
                </div>
                
                <h3 style="font-size: 1rem; margin-top: 1.5rem; margin-bottom: 1rem;">Équipements spéciaux supplémentaires</h3>
                <table class="dynamic-table" id="machines-manual-table">
                    <thead>
                        <tr>
                            <th>Équipement</th>
                            <th>Durée (jours)</th>
                            <th>Coût/jour (€)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="btn-add" id="add-machine-manual-btn">➕ Ajouter un équipement</button>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--info-border);">
                
                <div>
                    <label>Environnement spécifique</label>
                    <div class="checkbox-group" id="env-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="env-amiante" value="Zone Amiante">
                            <label for="env-amiante">Zone Amiante</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="env-plomb" value="Zone Plomb">
                            <label for="env-plomb">Zone Plomb</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="env-atex" value="Zone ATEX">
                            <label for="env-atex">Zone ATEX</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="env-confinement" value="Confinement requis">
                            <label for="env-confinement">Confinement requis</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="env-ventilation" value="Ventilation forcée">
                            <label for="env-ventilation">Ventilation forcée</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="form-title">6. Estimation Équipe & Durée</h2>
                <div class="form-grid-3">
                    <div>
                        <label>Nombre d'opérateurs estimé <span class="info-tooltip" data-tooltip="Basé sur la surface et complexité">ℹ️</span></label>
                        <input type="number" id="nb-operateurs" class="form-input" min="1" value="2">
                        <span class="print-only" id="print_operateurs"></span>
                    </div>
                    <div>
                        <label>Nombre d'heures estimé</label>
                        <input type="number" id="nb-heures" class="form-input" min="1" value="40">
                        <span class="print-only" id="print_heures"></span>
                    </div>
                    <div>
                        <label>Chef d'équipe assigné</label>
                        <select id="chef-equipe" class="form-select">
                            <option value="">À définir</option>
                            <option value="a-mohamed">A MOHAMED</option>
                            <option value="antunez-loic">ANTUNEZ LOIC</option>
                            <option value="clemente-mickael">CLEMENTE MICKAEL</option>
                            <option value="cukur-mustafa">CUKUR MUSTAFA</option>
                            <option value="grandadam-g">GRANDADAM G</option>
                            <option value="ribeiro-casal-a">RIBEIRO-CASAL A</option>
                            <option value="moreau-jc">MOREAU JC</option>
                        </select>
                        <span class="print-only" id="print_chef"></span>
                    </div>
                </div>
            </div>
            
            <div class="summary-panel">
                 <h2 class="form-title" style="color: white; border-color: var(--primary-orange);">📊 Résumé Technique</h2>
                 <div id="live-summary">
                     <p><em>Remplissez le formulaire pour voir le résumé...</em></p>
                 </div>
            </div>

             <div class="action-buttons">
                <button type="button" id="reset-btn" class="btn-action btn-reset">🔄 Remettre à zéro</button>
                <button type="button" id="print-btn" class="btn-action btn-print">🖨️ Imprimer</button>
            </div>

        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const produitsPeinture = [
                'IKARSUN - Primaire époxy',
                'Epodux Primaire 61-134',
                'Polystria - Finition PU',
                'EPODUX BR100 - Barrière époxy',
                'POLYSTRIA Satin',
                'POLYSTRIA Mat',
                'EPODUX ST 86-31',
                'LATEXOR - Peinture latex',
                'HEMPADUR 15570 - Époxy haute résistance',
                'HEMPATHANE 55210 - Polyuréthane',
                'SIGMASHIELD - Protection marine',
                'INTERTHANE 990 - Finition',
                'JOTAMASTIC 90 - Primaire universel'
            ];

            const machines = [
                'Nacelle élévatrice 12m',
                'Nacelle élévatrice 20m',
                'Échafaudage roulant',
                'Cuve à fuel mobile',
                'Compresseur 7 bars',
                'Compresseur haute pression',
                'Nettoyeur HP 200 bars',
                'Nettoyeur HP 500 bars',
                'Station airless 45:1',
                'Station airless 60:1',
                'Marmite chauffante',
                'Pistolet airless',
                'Pistolet HVLP',
                'Aspirateur industriel THE',
                'Extracteur d\'air 1000 m³/h',
                'Extracteur d\'air 2000 m³/h',
                'Masque ventilé 3M',
                'Combinaison jetable (lot 10)',
                'Bâche de protection PE',
                'Scotch de masquage'
            ];

            const surfaceTypes = [
                'Acier au carbone',
                'Acier galvanisé',
                'Acier inoxydable',
                'Aluminium',
                'Béton',
                'Bois',
                'Fonte',
                'Métallisation existante'
            ];

            const mainForm = document.getElementById('main-form');
            const summaryDiv = document.getElementById('live-summary');

            // Initialisation des selects
            function initializeSelects() {
                const machinesSelect = document.getElementById('machines-select');
                machines.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    option.textContent = m;
                    machinesSelect.appendChild(option);
                });
            }

            function updateSummary() {
                let summaryHTML = '<ul>';
                
                // Paramètres projet
                const corrosivite = document.getElementById('p_corrosivite').value;
                const complexite = document.getElementById('p_complexite').value;
                const environnement = document.getElementById('p_environnement').value;
                
                if (corrosivite || complexite || environnement) {
                    summaryHTML += `<li><strong>Projet :</strong> ${corrosivite} • ${complexite} • ${environnement}</li>`;
                }

                // Surfaces
                const surfaceRows = mainForm.querySelectorAll('#surfaces-table tbody tr');
                let totalSurface = Array.from(surfaceRows).reduce((sum, row) => {
                    const surfaceInput = row.querySelector('input[placeholder="m²"]');
                    return sum + (parseFloat(surfaceInput?.value) || 0);
                }, 0);
                
                if (totalSurface > 0) {
                    summaryHTML += `<li><strong>Surface totale :</strong> ${totalSurface.toFixed(2)} m²</li>`;
                }

                // Préparation
                let prepValues = Array.from(mainForm.querySelectorAll('#preparation-group input[type=checkbox]:checked')).map(cb => cb.value);
                const manualPreps = Array.from(mainForm.querySelectorAll('#prep-manual-table input')).map(input => input.value).filter(Boolean);
                prepValues.push(...manualPreps);
                if (prepValues.length > 0) {
                    summaryHTML += `<li><strong>Préparation :</strong> ${prepValues.join(', ')}</li>`;
                }

                // Peinture
                let coatSummaries = Array.from(mainForm.querySelectorAll('#coats-table tbody tr')).map(row => {
                    const produitSelect = row.querySelector('select');
                    const epaisseurInput = row.querySelector('input[placeholder="μm"]');
                    const produit = produitSelect?.value;
                    const epaisseur = epaisseurInput?.value;
                    return produit ? `${produit} (${epaisseur || 'N/A'} μm)` : null;
                }).filter(Boolean);
                
                if (coatSummaries.length > 0) {
                    summaryHTML += `<li><strong>Application :</strong> ${coatSummaries.join(' / ')}</li>`;
                }
                
                // Équipement
                let selectedMachines = Array.from(mainForm.querySelectorAll('#machines-select option:checked')).map(opt => opt.value);
                const manualMachines = Array.from(mainForm.querySelectorAll('#machines-manual-table tbody tr')).map(row => {
                    const equipInput = row.querySelector('input[placeholder="Équipement"]');
                    return equipInput?.value;
                }).filter(Boolean);
                selectedMachines.push(...manualMachines);
                
                if (selectedMachines.length > 0) {
                    summaryHTML += `<li><strong>Équipement :</strong> ${selectedMachines.join(', ')}</li>`;
                }

                // Environnement
                let envValues = Array.from(mainForm.querySelectorAll('#env-group input[type=checkbox]:checked')).map(cb => cb.value);
                if (envValues.length > 0) {
                    summaryHTML += `<li><strong>Environnement spécial :</strong> ${envValues.join(', ')}</li>`;
                }

                // Équipe
                const operateurs = mainForm.querySelector('#nb-operateurs').value;
                const heures = mainForm.querySelector('#nb-heures').value;
                const chef = mainForm.querySelector('#chef-equipe');
                const chefText = chef.options[chef.selectedIndex]?.text || 'À définir';
                
                if (operateurs || heures) {
                    summaryHTML += `<li><strong>Équipe :</strong> ${operateurs || 'N/A'} opérateurs, ${heures || 'N/A'} heures estimées</li>`;
                }
                
                if (chef.value) {
                    summaryHTML += `<li><strong>Chef d'équipe :</strong> ${chefText}</li>`;
                }

                // Mise à jour des textes pour l'impression
                updatePrintValues();

                summaryHTML += '</ul>';
                summaryDiv.innerHTML = summaryHTML;
            }

            function updatePrintValues() {
                const pairs = [
                    ['p_corrosivite', 'print_corrosivite'],
                    ['p_complexite', 'print_complexite'],
                    ['p_environnement', 'print_environnement'],
                    ['nb-operateurs', 'print_operateurs'],
                    ['nb-heures', 'print_heures'],
                    ['chef-equipe', 'print_chef']
                ];

                pairs.forEach(([inputId, printId]) => {
                    const input = document.getElementById(inputId);
                    const printEl = document.getElementById(printId);
                    if (input && printEl) {
                        if (input.tagName === 'SELECT') {
                            printEl.textContent = input.options[input.selectedIndex]?.text || '';
                        } else {
                            printEl.textContent = input.value || '';
                        }
                    }
                });
            }
            
            function addRow(tbody, innerHTML, placeholder = '') {
                const row = tbody.insertRow();
                row.innerHTML = innerHTML.replace(/PLACEHOLDER_TEXT/g, placeholder);
                const removeBtn = row.querySelector('.btn-remove');
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => { 
                        row.remove(); 
                        updateSummary(); 
                    });
                }
                return row;
            }

            // Ajout des lignes initiales
            initializeSelects();
            
            // Surface initiale
            const surfaceOptions = surfaceTypes.map(type => `<option value="${type}">${type}</option>`).join('');
            addRow(
                mainForm.querySelector('#surfaces-table tbody'), 
                `<td><select class="form-select">${surfaceOptions}</select></td>
                 <td><input type="number" class="form-input" placeholder="m²" min="0"></td>
                 <td><select class="form-select">
                     <option value="A">A - Neuf</option>
                     <option value="B">B - Bon état</option>
                     <option value="C" selected>C - État moyen</option>
                     <option value="D">D - Mauvais état</option>
                 </select></td>
                 <td><button type="button" class="btn-remove">×</button></td>`
            );

            // Couche de peinture initiale
            const productOptions = produitsPeinture.map(p => `<option value="${p}">${p}</option>`).join('');
            addRow(
                mainForm.querySelector('#coats-table tbody'), 
                `<td><select class="form-select">${productOptions}</select></td>
                 <td><input type="number" class="form-input" placeholder="μm" min="1"></td>
                 <td><input type="number" class="form-input" placeholder="m²/L" min="0.1" step="0.1"></td>
                 <td><button type="button" class="btn-remove">×</button></td>`
            );

            // Écouteurs d'événements
            mainForm.addEventListener('input', updateSummary);
            mainForm.addEventListener('change', updateSummary);
            
            document.getElementById('add-surface-btn').addEventListener('click', () => {
                addRow(
                    mainForm.querySelector('#surfaces-table tbody'), 
                    `<td><select class="form-select">${surfaceOptions}</select></td>
                     <td><input type="number" class="form-input" placeholder="m²" min="0"></td>
                     <td><select class="form-select">
                         <option value="A">A - Neuf</option>
                         <option value="B">B - Bon état</option>
                         <option value="C" selected>C - État moyen</option>
                         <option value="D">D - Mauvais état</option>
                     </select></td>
                     <td><button type="button" class="btn-remove">×</button></td>`
                );
                updateSummary();
            });

            document.getElementById('add-coat-btn').addEventListener('click', () => {
                addRow(
                    mainForm.querySelector('#coats-table tbody'), 
                    `<td><select class="form-select">${productOptions}</select></td>
                     <td><input type="number" class="form-input" placeholder="μm" min="1"></td>
                     <td><input type="number" class="form-input" placeholder="m²/L" min="0.1" step="0.1"></td>
                     <td><button type="button" class="btn-remove">×</button></td>`
                );
                updateSummary();
            });

            document.getElementById('add-prep-manual-btn').addEventListener('click', () => {
                addRow(
                    mainForm.querySelector('#prep-manual-table tbody'), 
                    `<td><input type="text" class="form-input" placeholder="Description de la préparation..."></td>
                     <td><input type="number" class="form-input" placeholder="m²" min="0"></td>
                     <td><button type="button" class="btn-remove">×</button></td>`
                );
                updateSummary();
            });

            document.getElementById('add-machine-manual-btn').addEventListener('click', () => {
                addRow(
                    mainForm.querySelector('#machines-manual-table tbody'), 
                    `<td><input type="text" class="form-input" placeholder="Équipement spécial..."></td>
                     <td><input type="number" class="form-input" placeholder="Durée" min="1"></td>
                     <td><input type="number" class="form-input" placeholder="€/jour" min="0" step="0.01"></td>
                     <td><button type="button" class="btn-remove">×</button></td>`
                );
                updateSummary();
            });
            
            document.getElementById('reset-btn').addEventListener('click', () => {
                if(confirm('Êtes-vous sûr de vouloir réinitialiser le formulaire ?')) { 
                    location.reload(); 
                }
            });
            
            document.getElementById('print-btn').addEventListener('click', () => {
                updatePrintValues();
                window.print();
            });

            // Sauvegarde automatique
            setInterval(() => {
                const formData = new FormData(mainForm);
                const data = Object.fromEntries(formData.entries());
                localStorage.setItem('travaux_materiaux_v1', JSON.stringify(data));
            }, 30000); // Sauvegarde toutes les 30 secondes

            updateSummary();
        });
    </script>
</body>
</html>