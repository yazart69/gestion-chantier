<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Chantier - Tugrul V0.8.1</title>
    

  <link rel="stylesheet" href="../assets/css/shared.css">
  <link rel="stylesheet" href="../assets/css/print.css" media="print">

</head>
<body>
  <div id="helpMount"></div>

    <div class="container">
        <nav class="back-nav">
            <a href="index.html" class="back-link">
                ‚Üê Retour √† l'accueil
            </a>
        </nav>

        <div class="page-header">
            <h1 class="page-title">Informations Chantier</h1>
            <p class="page-subtitle">Saisissez les informations g√©n√©rales et techniques du projet</p>
        </div>

        <form class="form-container" id="chantierForm">
            <section class="form-section">
                <h2 class="section-title">üìã Informations G√©n√©rales</h2>
                
                <div class="project-info-grid">
                    <div class="info-card">
                        <h4>üè¢ √âquipe 41 - Chasse sur Rh√¥ne</h4>
                        <p>Altrad Prezioso - R√©gion Auvergne-Rh√¥ne-Alpes</p>
                    </div>
                    <div class="info-card">
                        <h4>üìû Contact Principal</h4>
                        <p>MARTIN HANGARD - Responsable d'agence<br>
                        YASAR ERTUGRUL - Conducteur de travaux</p>
                    </div>
                </div>

                <div class="form-grid form-grid-2">
                    <div class="form-group">
                        <label class="form-label required" for="nomChantier">Nom du Chantier</label>
                        <input type="text" id="nomChantier" name="nomChantier" class="form-input" 
                               placeholder="Ex: Grand Lyon ‚Äì Pont de Chasse" required>
                        <span class="print-value" style="display: none;"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="numeroOTP">Num√©ro OTP/R√©f√©rence</label>
                        <input type="text" id="numeroOTP" name="numeroOTP" class="form-input" 
                               placeholder="Ex: 22111 13275" required>
                        <span class="print-value" style="display: none;"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="client">Client</label>
                        <input type="text" id="client" name="client" class="form-input" 
                               placeholder="Ex: M√©tropole de Lyon" required>
                        <span class="print-value" style="display: none;"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="typeChantier">Type de Chantier</label>
                        <select id="typeChantier" name="typeChantier" class="form-select">
                            <option value="parking">Parking</option>
                            <option value="industriel">Industriel</option>
                            <option value="infrastructure">Infrastructure</option>
                            <option value="batiment">B√¢timent</option>
                            <option value="petrochimie">P√©trochimie</option>
                            <option value="nucleaire">Nucl√©aire</option>
                            <option value="atelier">Atelier</option>
                        </select>
                        <span class="print-value" style="display: none;"></span>
                    </div>
                </div>
            </section>

            <section class="form-section">
                <h2 class="section-title">üõ†Ô∏è Types de Travaux (m¬≤)</h2>
                <div class="type-travaux-container">
                    <div id="typesTravauxContainer" class="travaux-grid">
                        <!-- Les types de travaux seront g√©n√©r√©s via JavaScript -->
                    </div>
                </div>
            </section>

            <section class="form-section">
                <h2 class="section-title">üìç Localisation</h2>
                <div class="form-grid form-grid-3">
                    <div class="form-group">
                        <label class="form-label required" for="adresse">Adresse du Chantier</label>
                        <input type="text" id="adresse" name="adresse" class="form-input" 
                               placeholder="Adresse compl√®te" required>
                        <span class="print-value" style="display: none;"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="ville">Ville</label>
                        <input type="text" id="ville" name="ville" class="form-input" 
                               placeholder="Ex: Lyon" required>
                        <span class="print-value" style="display: none;"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="codePostal">Code Postal</label>
                        <input type="text" id="codePostal" name="codePostal" class="form-input" 
                               placeholder="Ex: 69000" pattern="[0-9]{5}" required>
                        <span class="print-value" style="display: none;"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="acces">Acc√®s au site</label>
                        <select id="acces" name="acces" class="form-select">
                            <option value="publique">Publique</option>
                            <option value="restreint">Restreint</option>
                            <option value="securise">S√©curis√© (badge)</option>
                            <option value="accompagne">Accompagn√©</option>
                        </select>
                        <span class="print-value" style="display: none;"></span>
                    </div>
                </div>
            </section>

            <section class="form-section">
                <h2 class="section-title">üìÖ Planning</h2>
                <div class="form-grid form-grid-3">
                    <div class="form-group">
                        <label class="form-label required" for="dateDebut">Date de D√©but</label>
                        <input type="date" id="dateDebut" name="dateDebut" class="form-input" required>
                        <span class="print-value" style="display: none;"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="dateFin">Date de Fin Pr√©vue</label>
                        <input type="date" id="dateFin" name="dateFin" class="form-input" required>
                        <span class="print-value" style="display: none;"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dur√©e Estim√©e</label>
                        <input type="text" id="dureeEstimee" name="dureeEstimee" class="form-input" 
                               placeholder="Calcul automatique" readonly>
                        <span class="print-value" style="display: none;"></span>
                    </div>
                </div>
                
                <div class="planning-visual">
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-2);">
                        üìä Dur√©e calcul√©e (jours ouvr√©s uniquement)
                    </p>
                    <div class="duration-display" id="durationDisplay">-- jours</div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary);">
                        Hors week-ends et jours f√©ri√©s
                    </p>
                </div>
            </section>
            
            <section class="form-section">
                <h2 class="section-title">üë• Contacts et Responsables</h2>
                
                <div class="contacts-grid">
                    <div class="contact-info">
                        <strong>üìû Responsable d'Agence</strong><br>
                        MARTIN HANGARD<br>
                        Email: martin.hangard@altrad.com
                    </div>
                    <div class="contact-info">
                        <strong>üîß Conducteur de Travaux</strong><br>
                        YASAR ERTUGRUL<br>
                        Email: yasar.ertugrul@altrad.com
                    </div>
                    <div class="contact-info">
                        <strong>üíº Charg√© d'Affaires</strong><br>
                        SYLVAIN GARREAU<br>
                        Email: sylvain.garreau@altrad.com
                    </div>
                    <div class="contact-info">
                        <strong>üõ°Ô∏è Contact HSE</strong><br>
                        LOU PIEDIGROSSI<br>
                        Email: lou.piedigrossi@altrad.com
                    </div>
                </div>

                <div class="form-grid form-grid-2" style="margin-top: var(--space-6);">
                    <div class="form-group">
                        <label class="form-label required" for="chefChantier">Chef de Chantier</label>
                        <select id="chefChantier" name="chefChantier" class="form-select" required>
                            <option value="">S√©lectionner...</option>
                            <option value="farid-messal">FARID MESSAL</option>
                        </select>
                        <span class="print-value" style="display: none;"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Chefs d'√âquipe Assign√©s</label>
                        <select id="chefsEquipe" name="chefsEquipe" class="form-select" multiple>
                            <option value="a-mohamed">A MOHAMED</option>
                            <option value="antunez-loic">ANTUNEZ LOIC</option>
                            <option value="clemente-mickael">CLEMENTE MICKAEL</option>
                            <option value="cukur-mustafa">CUKUR MUSTAFA</option>
                            <option value="grandadam-g">GRANDADAM G</option>
                            <option value="ribeiro-casal-a">RIBEIRO-CASAL A</option>
                            <option value="moreau-jc">MOREAU JC</option>
                        </select>
                        <span class="print-value" style="display: none;"></span>
                    </div>
                </div>
            </section>
            
            <section class="form-section">
                <div class="atelier-section">
                    <h2 class="section-title">üè≠ Pi√®ces Atelier St Maurice</h2>
                    <div class="form-group">
                        <label class="form-label">Des pi√®ces seront-elles trait√©es √† l'atelier de St Maurice ?</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="atelierNon" name="traitementAtelier" value="non" checked>
                                <label for="atelierNon">Non</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="atelierOui" name="traitementAtelier" value="oui">
                                <label for="atelierOui">Oui</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="detailsAtelier" class="form-grid form-grid-3 hidden">
                        <div class="form-group">
                            <label class="form-label" for="atelierNombrePieces">Nombre de pi√®ces</label>
                            <input type="number" id="atelierNombrePieces" name="atelierNombrePieces" 
                                   class="form-input" min="0">
                            <span class="print-value" style="display: none;"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="atelierPrixParPiece">Prix par pi√®ce (‚Ç¨)</label>
                            <input type="number" id="atelierPrixParPiece" name="atelierPrixParPiece" 
                                   class="form-input" min="0" step="0.01">
                            <span class="print-value" style="display: none;"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total pi√®ces atelier (‚Ç¨)</label>
                            <input type="text" id="atelierTotal" name="atelierTotal" class="form-input" readonly>
                            <span class="print-value" style="display: none;"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="atelierPoidsTotal">Poids total (KG)</label>
                            <input type="number" id="atelierPoidsTotal" name="atelierPoidsTotal" 
                                   class="form-input" min="0">
                            <span class="print-value" style="display: none;"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="atelierM2Total">m¬≤ total des pi√®ces</label>
                            <input type="number" id="atelierM2Total" name="atelierM2Total" 
                                   class="form-input" min="0">
                            <span class="print-value" style="display: none;"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="atelierDateChargement">Date de chargement</label>
                            <input type="date" id="atelierDateChargement" name="atelierDateChargement" class="form-input">
                            <span class="print-value" style="display: none;"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="atelierDateLivraison">Date de livraison chantier</label>
                            <input type="date" id="atelierDateLivraison" name="atelierDateLivraison" class="form-input">
                            <span class="print-value" style="display: none;"></span>
                        </div>
                    </div>
                </div>
            </section>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="resetForm">üîÑ R√©initialiser</button>
                <button type="button" class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Imprimer</button>
                <button type="submit" class="btn btn-primary" id="saveForm">üíæ Enregistrer</button>
            </div>
        </form>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('chantierForm');
        
        // --- 1. GESTION DES TYPES DE TRAVAUX ---
        const typesTravaux = [
            'Sablage', 'Peinture industrielle', 'Nettoyage', 'Traitement anticorrosion', 
            'Peinture d√©corative', 'Remise en √©tat', 'Grenaillage', 'Nettoyage haute pression',
            'M√©tallisation', 'Projection thermique', 'Protection cathodique'
        ];
        
        const container = document.getElementById('typesTravauxContainer');

        typesTravaux.forEach(type => {
            const wrapper = document.createElement('div');
            wrapper.className = 'travaux-item';
            
            const checkboxId = `type-${type.toLowerCase().replace(/\s/g, '-')}`;
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = checkboxId;
            checkbox.name = 'types_travaux[]';
            checkbox.value = type;
            checkbox.className = 'travaux-checkbox';

            const label = document.createElement('label');
            label.htmlFor = checkboxId;
            label.textContent = type;
            label.className = 'travaux-label';
            
            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.name = `quantite_${checkboxId}`;
            quantityInput.placeholder = 'm¬≤';
            quantityInput.className = 'travaux-input form-input hidden';
            quantityInput.min = "0";

            checkbox.addEventListener('change', () => {
                quantityInput.classList.toggle('hidden', !checkbox.checked);
                if (!checkbox.checked) {
                    quantityInput.value = '';
                }
            });

            wrapper.appendChild(checkbox);
            wrapper.appendChild(label);
            wrapper.appendChild(quantityInput);
            container.appendChild(wrapper);
        });

        // --- 2. GESTION DU PLANNING ---
        const dateDebut = document.getElementById('dateDebut');
        const dateFin = document.getElementById('dateFin');
        const dureeField = document.getElementById('dureeEstimee');
        const durationDisplay = document.getElementById('durationDisplay');

        function calculateWorkingDays() {
            if (!dateDebut.value || !dateFin.value) {
                dureeField.value = '';
                durationDisplay.textContent = '-- jours';
                return;
            }

            let debut = new Date(dateDebut.value);
            let fin = new Date(dateFin.value);

            if (debut > fin) {
                dureeField.value = 'Date de fin invalide';
                durationDisplay.textContent = 'Erreur';
                return;
            }

            let workingDays = 0;
            let current = new Date(debut);
            
            while (current <= fin) {
                const day = current.getDay(); // 0 = Dimanche, 6 = Samedi
                if (day !== 0 && day !== 6) {
                    workingDays++;
                }
                current.setDate(current.getDate() + 1);
            }
            
            const durationText = `${workingDays} jour${workingDays > 1 ? 's' : ''}`;
            dureeField.value = durationText;
            durationDisplay.textContent = durationText;
        }

        dateDebut.addEventListener('change', calculateWorkingDays);
        dateFin.addEventListener('change', calculateWorkingDays);
        
        // --- 3. GESTION DE LA SECTION ATELIER ---
        const atelierOui = document.getElementById('atelierOui');
        const atelierNon = document.getElementById('atelierNon');
        const detailsAtelier = document.getElementById('detailsAtelier');

        atelierOui.addEventListener('change', () => {
            if (atelierOui.checked) {
                detailsAtelier.classList.remove('hidden');
            }
        });
        
        atelierNon.addEventListener('change', () => {
            if (atelierNon.checked) {
                detailsAtelier.classList.add('hidden');
            }
        });
        
        const nbPieces = document.getElementById('atelierNombrePieces');
        const prixPiece = document.getElementById('atelierPrixParPiece');
        const totalAtelier = document.getElementById('atelierTotal');

        function calculateAtelierTotal() {
            const nb = parseFloat(nbPieces.value) || 0;
            const prix = parseFloat(prixPiece.value) || 0;
            const total = (nb * prix).toFixed(2);
            totalAtelier.value = total + ' ‚Ç¨';
        }

        nbPieces.addEventListener('input', calculateAtelierTotal);
        prixPiece.addEventListener('input', calculateAtelierTotal);

        // --- 4. GESTION DES VALEURS D'IMPRESSION ---
        function updatePrintValues() {
            document.querySelectorAll('.form-input, .form-select').forEach(input => {
                const printValue = input.nextElementSibling;
                if (printValue && printValue.classList.contains('print-value')) {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        printValue.textContent = input.checked ? '‚úì' : '';
                    } else if (input.tagName === 'SELECT') {
                        printValue.textContent = input.options[input.selectedIndex]?.text || '';
                    } else {
                        printValue.textContent = input.value || '';
                    }
                }
            });
        }

        // Mettre √† jour les valeurs d'impression √† chaque changement
        form.addEventListener('input', updatePrintValues);
        form.addEventListener('change', updatePrintValues);

        // --- 5. GESTION DU FORMULAIRE ---
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Collecter les donn√©es
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Sauvegarder dans localStorage
            localStorage.setItem('chantier_data_v1', JSON.stringify(data));
            
            // Afficher une notification
            showNotification('Chantier enregistr√© avec succ√®s !', 'success');
        });
        
        document.getElementById('resetForm').addEventListener('click', () => {
            if (confirm('Voulez-vous vraiment r√©initialiser le formulaire ?')) {
                form.reset();
                detailsAtelier.classList.add('hidden');
                calculateWorkingDays();
                calculateAtelierTotal();
                updatePrintValues();
                showNotification('Formulaire r√©initialis√©', 'info');
            }
        });

        // --- 6. FONCTIONS UTILITAIRES ---
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <span>${type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Charger les donn√©es existantes
        function loadExistingData() {
            try {
                const saved = localStorage.getItem('chantier_data_v1');
                if (saved) {
                    const data = JSON.parse(saved);
                    Object.keys(data).forEach(key => {
                        const field = form.elements[key];
                        if (field) {
                            field.value = data[key];
                        }
                    });
                    calculateWorkingDays();
                    calculateAtelierTotal();
                    updatePrintValues();
                }
            } catch (error) {
                console.error('Erreur de chargement:', error);
            }
        }

        // Initialisation
        loadExistingData();
        updatePrintValues();
        
        // D√©finir la date d'aujourd'hui par d√©faut
        const today = new Date().toISOString().split('T')[0];
        if (!dateDebut.value) {
            dateDebut.value = today;
        }
    });
    </script>

  <script type="module">
    import { mountHelp } from '../assets/js/help.js';
    mountHelp(document.getElementById('helpMount') || document.body);
  </script>

</body>
</html>